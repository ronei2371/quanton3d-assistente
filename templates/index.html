<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QUANTON3D® — Suporte Técnico 3D</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
  <style>
    :root{
      --bg:#0b1220;          /* fundo escuro elegante */
      --panel:#0f1730;       /* cartões */
      --text:#e7f1ff;        /* texto principal */
      --muted:#9fc5ff;       /* texto suave */
      --line:#1c2744;        /* bordas */
      --brand:#00c2ff;       /* ciano Quanton */
      --brand2:#4f46e5;      /* indigo */
      --ok:#10b981;          /* verde ok */
      --warn:#f59e0b;        /* amarelo */
      --err:#ef4444;         /* vermelho */
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    a{color:var(--muted);text-decoration:none}
    a:hover{color:#fff;text-decoration:underline}

    /* topo com gradiente Quanton */
    .hero{
      background: radial-gradient(1200px 600px at 20% -10%, rgba(79,70,229,.35), transparent 60%),
                  linear-gradient(90deg, var(--brand2), var(--brand));
      padding:24px 16px 100px 16px;
      position:relative;
      overflow:hidden;
    }
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}

    .brand-row{display:flex;align-items:center;gap:16px}
    .brand-logo{
      width:52px;height:52px;border-radius:14px;
      background:#0008;display:flex;align-items:center;justify-content:center;
      box-shadow:0 8px 30px #0008;overflow:hidden
    }
    .brand-logo img{width:100%;height:100%;object-fit:cover}

    h1{
      margin:0;
      font-size:clamp(22px, 2.4vw + 16px, 40px);
      line-height:1.05;
      letter-spacing:.3px;
    }
    .brand-mark{font-weight:900}
    .brand-mark sup{font-size:.55em; top:-0.7em; position:relative}
    .subtitle{
      display:block;
      font-weight:600;
      opacity:.92;
      margin-top:6px;
      font-size:clamp(14px, 1.1vw + 10px, 18px);
    }

    /* chips de topo */
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .chip{
      background:#ffffff22;border:1px solid #ffffff33;color:#eaf6ff;
      border-radius:999px;padding:6px 12px;font-size:13px;backdrop-filter:blur(6px)
    }
    .mode-toggle{cursor:pointer}

    /* cartão formulário */
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      margin-top:-64px;
      box-shadow:0 15px 60px rgba(0,0,0,.35);
    }
    .card-body{padding:18px}

    /* grid dos campos */
    .grid{
      display:grid; gap:14px;
      grid-template-columns:1fr;
    }
    @media(min-width:860px){
      .grid{grid-template-columns:1fr 1fr}
      .grid span.full{grid-column:1 / span 2}
    }

    label{display:block;font-weight:700;font-size:14px;margin:6px 0 6px 2px}
    .hint{font-weight:500;color:var(--muted);font-size:12px;margin:0 0 10px 2px}
    input[type="text"], input[type="tel"], select, textarea{
      width:100%; background:#0b1328; color:var(--text);
      border:1.5px solid #193057; border-radius:12px;
      padding:12px 14px; outline:none; font-size:15px;
      transition: .15s border, .15s box-shadow, .15s background;
    }
    textarea{min-height:120px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: var(--brand);
      box-shadow:0 0 0 4px rgba(0,194,255,.18);
      background:#0b1530;
    }
    .file-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    input[type="file"]{font-size:14px}
    .small{font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .btn{
      appearance:none;border:none;cursor:pointer;
      border-radius:14px;padding:12px 18px;font-weight:800;
      letter-spacing:.2px;font-size:15px;
      transition: .15s transform, .15s filter, .15s opacity;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      color:#00111a;background:linear-gradient(90deg,var(--brand),#36e1ff);
      box-shadow: 0 10px 30px rgba(0,194,255,.35), inset 0 -2px 0 #00a1d4;
    }
    .btn-ghost{background:#10203a;color:#d8ecff;border:1px solid #1a2d50}
    .btn[disabled]{opacity:.45;cursor:not-allowed;filter:grayscale(.3)}

    /* mensagens */
    .feed{padding:6px 0 4px}
    .bubble{border:1px solid var(--line); border-radius:12px; padding:12px 14px; margin:8px 0}
    .me{background:#0b162a}
    .bot{background:#0f1a33}

    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .warn{color:var(--warn)}
    .link-row{display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:10px}
    .brand-badge{display:inline-flex;align-items:center;gap:8px;font-weight:700}

    /* destaque dos selects */
    select{appearance:none;background-image:
      linear-gradient(45deg, transparent 50%, var(--muted) 50%),
      linear-gradient(135deg, var(--muted) 50%, transparent 50%),
      linear-gradient(to right, #0b1328, #0b1328);
      background-position: calc(100% - 18px) calc(1em + 2px),
                           calc(100% - 13px) calc(1em + 2px),
                           100% 0;
      background-size: 5px 5px, 5px 5px, 2.8em 2.8em;
      background-repeat: no-repeat;
      padding-right:42px;
    }
    .terms{
      display:flex; align-items:center; gap:10px; margin-top:6px;
      border-top:1px solid var(--line); padding-top:10px; color:var(--muted); font-size:13px;
    }
  </style>
</head>
<body>

  <header class="hero">
    <div class="wrap">
      <div class="brand-row">
        <div class="brand-logo">
          <!-- coloque static/logo.png (oficial) -->
          <img src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D">
        </div>
        <div>
          <h1>
            <span class="brand-mark">QUANTON3D<sup>®</sup></span>
            <span class="subtitle">Suporte Técnico 3D • SLA/DLP</span>
          </h1>
          <div class="chips">
            <span class="chip">v {{ app_version }}</span>
            <a class="chip" href="#" id="modeBtn">Modo Certeiro</a>
            <a class="chip" href="https://quanton3d.com.br" target="_blank">Site Quanton3D</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-body">
        <form id="form" enctype="multipart/form-data" class="grid">
          <!-- Telefone -->
          <span>
            <label for="phone">Telefone (WhatsApp)</label>
            <input id="phone" name="phone" type="tel" placeholder="(31) 9 0000-0000" required />
            <p class="hint">Use sempre o mesmo número — ele vincula seu histórico.</p>
          </span>

          <!-- Onde está o problema -->
          <span>
            <label for="scope">Onde está o problema?</label>
            <select id="scope" name="scope">
              <option value="">Selecione…</option>
              <option value="lcd">Tela / LCD</option>
              <option value="adesao">Adesão / Base</option>
              <option value="suportes">Suportes</option>
              <option value="fep">FEP / Cuba</option>
              <option value="resina">Resina</option>
              <option value="arquivo">Arquivo / Fatiamento</option>
              <option value="mecanico">Mecânico / Z / Ruídos</option>
              <option value="outro">Outro</option>
            </select>
          </span>

          <!-- Resina -->
          <span>
            <label for="resin">Resina (opcional — catálogo Quanton3D em breve)</label>
            <input id="resin" name="resin" type="text" placeholder="Ex.: Q3D Dental / Flex / Tough…" />
          </span>

          <!-- Impressora -->
          <span>
            <label for="printer">Impressora (opcional — catálogo em breve)</label>
            <input id="printer" name="printer" list="printerList" placeholder="Ex.: Anycubic Photon Mono X, Elegoo Saturn…" />
            <datalist id="printerList"></datalist>
          </span>

          <!-- Problema -->
          <span class="full">
            <label for="problem">Descreva o problema</label>
            <textarea id="problem" name="problem" placeholder="Explique o que está acontecendo…" required></textarea>
          </span>

          <!-- Fotos -->
          <span class="full">
            <label>Imagens (JPG/PNG/WEBP, máx 5 — 3MB cada)</label>
            <div class="file-row">
              <input id="photos" name="photos" type="file" accept="image/*" multiple />
              <span class="small">Dica: foto da tela acesa ajuda MUITO nos casos de LCD/backlight.</span>
            </div>
          </span>

          <span class="full terms">
            <input type="checkbox" id="termsCheck" />
            <label for="termsCheck" style="margin:0;">Li e aceito os <a href="#" id="termsLink">termos de uso</a> e a <a href="#" id="privacyLink">política de privacidade</a>.</label>
          </span>

          <span class="full actions">
            <button class="btn btn-ghost" type="button" id="resetBtn">Reset do meu histórico</button>
            <button class="btn btn-primary" type="submit" id="sendBtn" disabled>Enviar</button>
          </span>
        </form>

        <!-- Feed de mensagens -->
        <div class="feed" id="feed"></div>

        <div class="link-row">
          <span class="brand-badge">© QUANTON3D — todos os direitos reservados</span>
          <a href="#" id="rights">Direitos autorais</a>
          <a href="#" id="privacy">Privacidade</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== aparência / interações
    const el = (id)=>document.getElementById(id);
    const feed = el('feed');
    const sendBtn = el('sendBtn');
    const termsCheck = el('termsCheck');
    const phone = el('phone');

    // liga/desliga botão de envio conforme termos
    termsCheck.addEventListener('change', ()=> sendBtn.disabled = !termsCheck.checked);

    // máscara simples do telefone (BR)
    phone.addEventListener('input', (e)=>{
      let v = e.target.value.replace(/\D/g,'').slice(0,11);
      if(v.length>6) e.target.value = `(${v.slice(0,2)}) ${v.slice(2,3)} ${v.slice(3,7)}-${v.slice(7)}`;
      else if(v.length>2) e.target.value = `(${v.slice(0,2)}) ${v.slice(2)}`;
      else e.target.value = v;
    });

    // “Modo Certeiro”: apenas etiqueta visual (o back-end já entende esse estilo)
    const modeBtn = el('modeBtn');
    let certeiro = true;
    modeBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); certeiro=!certeiro; modeBtn.textContent = certeiro?'Modo Certeiro':'Modo Livre'; });

    // termos/privacidade – abre pop simples
    function showText(title, html){
      const w = window.open('', '_blank', 'width=480,height=640');
      w.document.write('<meta charset="utf-8"><title>'+title+'</title><style>body{font-family:system-ui;padding:20px;line-height:1.5} h2{margin-top:0}</style><h2>'+title+'</h2>'+html);
      w.document.close();
    }
    el('termsLink').onclick = (e)=>{e.preventDefault(); showText('Termos de Uso', `
      <p>Ao continuar, você declara que:</p>
      <ul>
        <li>Reconhece que o bot é propriedade exclusiva da QUANTON3D®;</li>
        <li>O uso é permitido apenas para suporte em impressão 3D;</li>
        <li>É proibida a cópia, modificação ou redistribuição;</li>
        <li>As informações são apoio técnico e não substituem decisões profissionais;</li>
        <li>Violação implica em bloqueio de acesso e medidas legais.</li>
      </ul>`); };
    el('privacyLink').onclick = (e)=>{e.preventDefault(); showText('Privacidade', '<p>Coletamos apenas os dados necessários para prestar suporte (telefone, descrição e imagens). Não vendemos seus dados.</p>');};
    el('rights').onclick = (e)=>{e.preventDefault(); showText('Direitos autorais', '<p>QUANTON3D® – todos os direitos reservados. Marca e identidade visual registradas.</p>');};
    el('privacy').onclick = el('privacyLink').onclick;

    // lista de impressoras (tenta carregar /static/printers.json; senão usa fallback)
    const fallbackPrinters = [
      "Anycubic Photon Mono", "Anycubic Photon Mono X", "Anycubic Photon Mono X 6K", "Anycubic Photon Mono M5",
      "Elegoo Mars", "Elegoo Mars 2 Pro", "Elegoo Mars 3 Pro", "Elegoo Saturn", "Elegoo Saturn 2", "Elegoo Saturn 3", "Elegoo Saturn 3 Ultra", "Elegoo Saturn 4 Ultra",
      "Creality LD-002H", "Creality Halot-One", "Creality Halot-Sky",
      "Phrozen Sonic Mini 4K", "Phrozen Sonic Mighty 4K", "Phrozen Sonic Mighty 8K"
    ];
    fetch("{{ url_for('static', filename='printers.json') }}", {cache:"no-store"})
      .then(r=> r.ok ? r.json() : Promise.reject())
      .then(list => fillPrinters(list))
      .catch(()=> fillPrinters(fallbackPrinters));
    function fillPrinters(list){
      const dl = document.getElementById('printerList');
      dl.innerHTML = '';
      (list||[]).forEach(name=>{
        const o = document.createElement('option'); o.value = name; dl.appendChild(o);
      });
    }

    // reset do histórico por telefone
    el('resetBtn').addEventListener('click', ()=>{
      const tel = phone.value.replace(/\D/g,'');
      if(!tel){ alert("Digite o telefone para eu localizar seu histórico."); return; }
      window.open(`/reset?phone=${tel}`, '_blank');
    });

    // helper para colocar bolhas
    function bubble(text, cls){
      const b = document.createElement('div');
      b.className = 'bubble '+(cls||'');
      b.innerHTML = text.replace(/\n/g,'<br>');
      feed.prepend(b);
    }

    // envio do formulário
    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!termsCheck.checked){ alert("Marque que aceita os termos para continuar."); return; }

      const fd = new FormData(e.target);
      // backend atual aceita "photos" (várias)
      const files = document.getElementById('photos').files;
      if(files?.length){ for(const f of files){ fd.append('photos', f); } }

      // mostra a pergunta no feed
      bubble(`<strong>Você:</strong><br>${(fd.get('problem')||'').toString()}`, 'me');

      sendBtn.disabled = true;
      sendBtn.textContent = 'Enviando…';

      try{
        const r = await fetch('/chat', { method:'POST', body: fd });
        const js = await r.json();
        if(js?.ok){
          const text = (js.reply || js.answer || '(sem resposta)').toString();
          bubble(`<strong>Assistente:</strong><br>${text}`, 'bot');
        }else{
          bubble(`<span class="err"><strong>Erro:</strong> ${js?.error || 'Falha ao enviar'}</span>`, 'bot');
        }
      }catch(err){
        bubble(`<span class="err"><strong>Erro de rede:</strong> ${err}</span>`, 'bot');
      }finally{
        sendBtn.disabled = !termsCheck.checked;
        sendBtn.textContent = 'Enviar';
      }
    });
  </script>
</body>
</html>
