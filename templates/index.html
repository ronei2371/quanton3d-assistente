<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IA Quanton3D — Suporte Técnico 3D</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" sizes="any" />

  <!-- Fonte & CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='site.css') }}" />
</head>
<body>

  <!-- HEADER / FAIXA -->
  <header class="brand">
    <div class="brand-inner">
      <img class="brand-logo" src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D" />
      <div class="brand-text">
        <div class="brand-title">IA Quanton3D<span class="reg">®</span></div>
        <div class="brand-tagline">Suporte Técnico 3D • SLA/DLP</div>
      </div>
      <nav class="brand-links">
        <a href="https://quanton3d.com.br" target="_blank" rel="noopener">Site Quanton3D</a>
        <a href="#" id="toggle-modo">Modo Certeiro</a>
      </nav>
    </div>
  </header>

  <!-- HERO (banner com fotos) -->
  <section class="hero">
    <div class="hero-slide">
      <!-- Apenas coloque os arquivos em static/hero/ com estes nomes -->
      <img src="{{ url_for('static', filename='hero/spark.webp') }}" alt="Spark" />
      <img src="{{ url_for('static', filename='hero/alchemist-pink.webp') }}" alt="Alchemist Pink" />
      <img src="{{ url_for('static', filename='hero/alchemist-violet.webp') }}" alt="Alchemist Violet" />
      <img src="{{ url_for('static', filename='hero/iron.png') }}" alt="Iron" />
      <img src="{{ url_for('static', filename='hero/flex.png') }}" alt="Flex" />
      <img src="{{ url_for('static', filename='hero/dental.webp') }}" alt="Dental" />
    </div>
  </section>

  <main class="wrap">

    <!-- Aviso / Termos (checkbox no formulário) -->
    <section class="panel notice">
      <label class="checkline">
        <input type="checkbox" id="accept" />
        <span>Eu li e aceito os <a href="#" id="show-terms">termos de uso</a> e a <a href="#" id="show-privacy">política de privacidade</a>.</span>
      </label>
    </section>

    <!-- FORM -->
    <form id="form" class="panel" enctype="multipart/form-data">
      <div class="grid">
        <div class="col">
          <label>Telefone (WhatsApp)</label>
          <input id="phone" name="phone" type="tel" inputmode="numeric" placeholder="(31) 9 0000-0000" required />
          <small>Use sempre o mesmo telefone — ele vincula seu histórico.</small>
        </div>
        <div class="col">
          <label>Onde está o problema?</label>
          <select id="scope" name="scope">
            <option value="">Selecione…</option>
            <option value="LCD">LCD / Backlight / Tela</option>
            <option value="Adesao">Adesão / Primeiras camadas</option>
            <option value="Suportes">Suportes / Geometria</option>
            <option value="Geral">Geral</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div class="col">
          <label>Resina (opcional — catálogo Quanton3D em breve)</label>
          <input id="resin" name="resin" type="text" placeholder="Ex.: Q3D Dental / Flex / Tough…" />
        </div>
        <div class="col">
          <label>Impressora (opcional — catálogo em breve)</label>
          <input id="printer" name="printer" list="printer-list" placeholder="Ex.: Anycubic Photon Mono X, Elegoo Saturn…" />
          <datalist id="printer-list"></datalist>
        </div>
      </div>

      <div>
        <label>Descreva o problema</label>
        <textarea id="problem" name="problem" rows="5" placeholder="Explique o que está acontecendo…" required></textarea>
      </div>

      <div>
        <label>Imagens (JPG/PNG/WEBP, máx 5 — 3MB cada)</label>
        <input id="photos" name="photos" type="file" accept=".jpg,.jpeg,.png,.webp" multiple />
        <small>Dica: foto da tela acesa ajuda MUITO nos casos de LCD/backlight.</small>
      </div>

      <div class="actions">
        <button id="btn-reset" type="button" class="btn ghost">Reset do meu histórico</button>
        <button id="btn-send" class="btn primary" disabled>Enviar</button>
      </div>
    </form>

    <!-- RESPOSTAS -->
    <section id="chat" class="panel">
      <div class="panel-title">Respostas</div>
      <div id="msgs" class="msgs"></div>
    </section>

    <footer class="footer">
      © QUANTON3D — todos os direitos reservados •
      <a href="#" id="show-terms-2">Direitos autorais</a> •
      <a href="#" id="show-privacy-2">Privacidade</a>
    </footer>
  </main>

  <!-- DIALOGOS -->
  <dialog id="dlg-terms" class="dialog">
    <h3>Termos de Uso – Bot Quanton3D</h3>
    <p>• O bot é propriedade exclusiva da Quanton3D.<br>
       • Uso permitido apenas para suporte em impressão 3D.<br>
       • É proibida a cópia, modificação ou redistribuição.<br>
       • As informações são apoio técnico e não substituem decisões profissionais.<br>
       • Violação implica em bloqueio de acesso e medidas legais.</p>
    <div class="dialog-actions"><button class="btn" data-close>Fechar</button></div>
  </dialog>

  <dialog id="dlg-privacy" class="dialog">
    <h3>Privacidade</h3>
    <p>Usamos os dados somente para orientar o suporte. Você pode solicitar a remoção do histórico a qualquer momento.</p>
    <div class="dialog-actions"><button class="btn" data-close>Fechar</button></div>
  </dialog>

  <!-- GATE: abre ao carregar e bloqueia até aceitar -->
  <dialog id="dlg-gate" class="dialog">
    <h3>Bem-vindo!</h3>
    <p>Para continuar, é necessário aceitar nossos termos e política.</p>
    <label class="checkline">
      <input type="checkbox" id="gate-check" />
      <span>Eu aceito os <a href="#" id="gate-terms">termos de uso</a> e a <a href="#" id="gate-privacy">política de privacidade</a>.</span>
    </label>
    <div class="dialog-actions">
      <button class="btn primary" id="gate-accept">Aceito e continuar</button>
    </div>
  </dialog>

  <script>
  let modoCerteiro = true;

  const accept = document.getElementById('accept');
  const btnSend = document.getElementById('btn-send');

  // ===== Modais auxiliares
  function wireDialog(linkId, dlgId){
    const link = document.getElementById(linkId);
    const dlg  = document.getElementById(dlgId);
    const close = () => dlg.close();
    link.addEventListener('click', e => { e.preventDefault(); dlg.showModal(); });
    dlg.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', close));
  }
  wireDialog('show-terms','dlg-terms'); wireDialog('show-privacy','dlg-privacy');
  wireDialog('show-terms-2','dlg-terms'); wireDialog('show-privacy-2','dlg-privacy');

  // ===== GATE (bloqueio inicial)
  const dlgGate = document.getElementById('dlg-gate');
  const gateCheck = document.getElementById('gate-check');
  const gateAccept = document.getElementById('gate-accept');
  document.getElementById('gate-terms').addEventListener('click', e=>{e.preventDefault(); document.getElementById('dlg-terms').showModal();});
  document.getElementById('gate-privacy').addEventListener('click', e=>{e.preventDefault(); document.getElementById('dlg-privacy').showModal();});

  function setAccepted(v){
    localStorage.setItem('q3d_terms_ok', v ? '1' : '0');
    accept.checked = !!v;
    btnSend.disabled = !v;
  }

  // Estado inicial
  document.addEventListener('DOMContentLoaded', () => {
    const ok = localStorage.getItem('q3d_terms_ok') === '1';
    setAccepted(ok);
    if(!ok) dlgGate.showModal();
  });

  gateAccept.addEventListener('click', () => {
    if(!gateCheck.checked){ alert('Marque a caixa de aceite.'); return; }
    setAccepted(true);
    dlgGate.close();
  });

  // Checkbox do painel também controla
  accept.addEventListener('change', () => setAccepted(accept.checked));

  // Toggle modo
  document.getElementById('toggle-modo').addEventListener('click', e => {
    e.preventDefault();
    modoCerteiro = !modoCerteiro;
    e.target.textContent = modoCerteiro ? 'Modo Certeiro' : 'Modo Livre';
  });

  // Lista de impressoras
  fetch('{{ url_for("static", filename="printers.json") }}')
    .then(r => r.ok ? r.json() : [])
    .then(list => {
      const dl = document.getElementById('printer-list');
      (list || []).forEach(n => { const o=document.createElement('option'); o.value=n; dl.appendChild(o); });
    }).catch(()=>{});

  // Reset histórico
  document.getElementById('btn-reset').addEventListener('click', () => {
    const phone = document.getElementById('phone').value.trim();
    if(!phone){ alert('Informe o telefone.'); return; }
    window.open(`/reset?phone=${encodeURIComponent(phone)}`, '_blank');
  });

  // Envio
  document.getElementById('form').addEventListener('submit', async ev => {
    ev.preventDefault();
    if(!accept.checked){ alert('Você precisa aceitar os termos.'); return; }

    const fd = new FormData();
    fd.append('phone',  (document.getElementById('phone').value || '').trim());
    fd.append('scope',  (document.getElementById('scope').value || '').trim());
    fd.append('resin',  (document.getElementById('resin').value || '').trim());
    fd.append('printer',(document.getElementById('printer').value || '').trim());
    fd.append('problem',(document.getElementById('problem').value || '').trim());
    const files = document.getElementById('photos').files;
    for(let i=0;i<Math.min(files.length,5);i++){ fd.append('photos', files[i]); }

    btnSend.disabled = true; btnSend.textContent = 'Enviando…';
    try{
      const r = await fetch('/chat', { method:'POST', body: fd });
      const j = await r.json();
      const text = j.reply || j.answer || j.error || '(sem resposta)';
      addMsg('Você', document.getElementById('problem').value);
      addMsg('Assistente', text);
    }catch(e){
      addMsg('Assistente', 'Falha ao enviar. Tente novamente.');
    }finally{
      btnSend.disabled = !accept.checked; btnSend.textContent = 'Enviar';
    }
  });

  function addMsg(role, text){
    const box = document.createElement('div');
    box.className = 'msg ' + (role==='Você' ? 'user':'bot');
    box.innerHTML = `<div class="who">${role}:</div><div class="bubble">${escapeHtml(text)}</div>`;
    document.getElementById('msgs').prepend(box);
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // ===== HERO rotativo (troca as imagens a cada 5s)
  const heroImgs = document.querySelectorAll('.hero-slide img');
  function showHero(i){ heroImgs.forEach((im,k)=>im.style.opacity = k===i ? '1':'0'); }
  if(heroImgs.length){ let idx=0; showHero(0); setInterval(()=>{ idx=(idx+1)%heroImgs.length; showHero(idx); }, 5000); }
  </script>
</body>
</html>
