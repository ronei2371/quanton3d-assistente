<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUANTON3DÂ® â€” Suporte TÃ©cnico SLA/DLP</title>
  <style>
    :root{
      --bg:#0f131a; --panel:#121827; --ink:#e9eef5; --muted:#a8b3c7; --brand:#3aa0ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --stroke:#233047;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,sans-serif}
    header{display:flex;align-items:center;gap:14px;padding:16px 18px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg,#0f131a,#0d121b)}
    header img{height:30px}
    header h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.3px}
    main{max-width:980px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--stroke);background:#0b1019;color:var(--ink);outline:none}
    textarea{min-height:110px;resize:vertical}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .btn{cursor:pointer;border:1px solid var(--stroke);background:#122037;color:#fff;border-radius:12px;padding:12px 16px;font-weight:800}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-brand{background:linear-gradient(135deg,#3aa0ff,#2b68ff)}
    .grid-2{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
    .msgs{display:flex;flex-direction:column-reverse;gap:10px} /* mais novo em cima */
    .msg{border:1px solid var(--stroke);border-radius:12px;padding:12px;background:#0e1625}
    .me{background:#0b1a2b}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    .top-actions{display:flex;gap:10px;align-items:center}
    .pill{border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;color:#cfe3ff;background:#0d1b2e}
    a {color:#8bd0ff}
  </style>
</head>
<body>
<header>
  <img src="/static/logo.png" alt="QUANTON3D" onerror="this.style.display='none'">
  <h1>QUANTON3DÂ® â€” Suporte TÃ©cnico SLA/DLP</h1>
  <span class="pill">v {{ app_version }}</span>
  <span style="flex:1"></span>
  <button class="btn" id="btn-autorais">Direitos autorais</button>
</header>

<main>
  <section class="card">
    <div class="top-actions">
      <div class="badge">Use sempre o mesmo telefone â€” ele vincula seu histÃ³rico.</div>
      <a class="badge" href="/healthz" target="_blank">healthz</a>
      <a class="badge" href="/diag" target="_blank">diag</a>
    </div>

    <form id="form">
      <label>Telefone</label>
      <input name="phone" placeholder="11999999999" required>

      <div class="row">
        <div>
          <label>ParÃ¢metros de impressÃ£o Quanton3D â€” <span class="muted">Resina</span></label>
          <input name="resin" placeholder="Preencha se quiser registrar">
        </div>
        <div>
          <label>ParÃ¢metros de impressÃ£o Quanton3D â€” <span class="muted">Impressora</span></label>
          <input name="printer" placeholder="Preencha se quiser registrar">
        </div>
      </div>

      <label>Descreva seu problema</label>
      <textarea name="problem" placeholder="Ex.: manchas na tela, linhas claras, peÃ§a nÃ£o adere..."></textarea>

      <div class="grid-2">
        <div>
          <label>Imagens (JPG/PNG/WEBP, mÃ¡x 5 â€¢ 3MB cada)</label>
          <input type="file" id="images" name="images" accept="image/jpeg,image/png,image/webp" multiple>
          <div class="hint" id="img-hint">Nenhuma imagem selecionada.</div>
        </div>
        <button class="btn btn-brand" id="send">Enviar</button>
      </div>
      <div class="hint">Dica: se for iPhone/HEIC, exporte como JPEG/PNG antes de enviar.</div>
    </form>
  </section>

  <section class="card">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <strong>Respostas</strong>
      <span class="badge">Mais novas no topo</span>
    </div>
    <div class="msgs" id="msgs"></div>
  </section>
</main>

<script>
const form = document.getElementById('form');
const sendBtn = document.getElementById('send');
const msgs = document.getElementById('msgs');
const imgInput = document.getElementById('images');
const imgHint = document.getElementById('img-hint');

imgInput.addEventListener('change', () => {
  const files = [...imgInput.files];
  if (!files.length) { imgHint.textContent = "Nenhuma imagem selecionada."; return; }
  const total = files.reduce((s,f)=>s+(f.size||0),0);
  imgHint.textContent = `${files.length} imagem(ns) â€” ${(total/1024/1024).toFixed(2)} MB`;
});

function prependMsg(html){
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = html;
  msgs.prepend(div);
}

function me(text){
  prependMsg(`<div class="me">${text.replaceAll('\n','<br>')}</div>`);
}
function bot(text){
  prependMsg(`${text.replaceAll('\n','<br>')}`);
}

function mdEscape(s){return s}

form.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  if (sendBtn.disabled) return;

  // valida imagens (mÃ¡x 5, 3MB cada)
  const files = [...imgInput.files];
  if (files.length > 5) { alert("MÃ¡ximo de 5 imagens."); return; }
  for (const f of files) {
    if (f.size > 3*1024*1024) { alert("Cada imagem deve ter atÃ© 3MB."); return; }
  }

  const fd = new FormData(form);
  me(`<b>VocÃª</b>:<br>${mdEscape(form.problem.value)}`);

  sendBtn.disabled = true; sendBtn.textContent = "Enviando...";
  try{
    const r = await fetch('/chat', { method:'POST', body:fd });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'Falha inesperada');

    bot(`<b>Assistente</b>:<br>${j.answer}`);
  }catch(err){
    bot(`<span class="err">Erro:</span> ${err.message}`);
  }finally{
    sendBtn.disabled = false; sendBtn.textContent = "Enviar";
  }
});

// Direitos autorais (modal simples)
document.getElementById('btn-autorais').addEventListener('click', ()=>{
  alert(`ðŸ“œ ConteÃºdo exclusivo da marca Quanton3DÂ®.
Esta IA segue diretrizes e vocabulÃ¡rio tÃ©cnico prÃ³prios.
Uso e reproduÃ§Ã£o nÃ£o autorizados sÃ£o proibidos (Lei nÂº 9.279/96).`);
});
</script>
</body>
</html>
