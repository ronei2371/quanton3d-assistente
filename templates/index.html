<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>QUANTON3D® — Suporte Técnico SLA/DLP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0b1220;color:#e7ecf3;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    .card{max-width:900px;margin:0 auto;background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:16px}
    h1{margin:8px 0 16px 0;font-size:20px}
    label{display:block;margin-top:12px;font-size:14px;opacity:.9}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #293652;background:#0b1220;color:#e7ecf3}
    button{margin-top:12px;padding:10px 16px;border-radius:8px;border:0;background:#3b82f6;color:white;cursor:pointer}
    .log{margin-top:16px;background:#0b1220;border:1px solid #1f2a44;border-radius:8px;padding:10px;max-height:420px;overflow:auto}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#111827;border:1px solid #1f2937;font-size:12px;margin-left:8px;opacity:.8}
    .you{color:#93c5fd}
    .bot{color:#86efac}
    small{opacity:.7}
  </style>
</head>
<body>
  <div class="card">
    <h1>QUANTON3D® — Suporte Técnico SLA/DLP
      <span class="pill">v <span id="ver">?</span></span>
      <span class="pill"><span id="model">?</span></span>
    </h1>

    <label>Telefone (WhatsApp)</label>
    <input id="phone" placeholder="(31) 98334-0053" />

    <div style="display:flex; gap:12px;">
      <div style="flex:1;">
        <label>Parâmetros de impressão — Resina (opcional)</label>
        <input id="resin" placeholder="(só preencha se quiser perfil/exposição)"/>
      </div>
      <div style="flex:1;">
        <label>Parâmetros de impressão — Impressora (opcional)</label>
        <input id="printer" placeholder="(só preencha se quiser perfil/exposição)"/>
      </div>
    </div>

    <label>Descreva o problema</label>
    <textarea id="problem" rows="4" placeholder="Ex.: minhas peças estão rachando..."></textarea>

    <label>Imagens (JPG/PNG/WEBP — até 5; máx 3MB cada)</label>
    <input id="images" type="file" multiple accept=".jpg,.jpeg,.png,.webp" />

    <button id="send">Enviar</button>

    <div class="log" id="log"></div>
  </div>

  <script>
    async function diag() {
      const r = await fetch("/diag");
      const j = await r.json();
      document.getElementById("ver").textContent   = j.version || "?";
      document.getElementById("model").textContent = j.model   || "?";
    }
    diag();

    function addLine(who, text){
      const el = document.getElementById("log");
      const p = document.createElement("p");
      p.innerHTML = `<span class="${who==='Você'?'you':'bot'}">${who}:</span> ${text}`;
      el.prepend(p);
    }

    document.getElementById("send").onclick = async () => {
      const fd = new FormData();
      fd.append("phone",   document.getElementById("phone").value);
      fd.append("resin",   document.getElementById("resin").value);
      fd.append("printer", document.getElementById("printer").value);
      fd.append("problem", document.getElementById("problem").value);
      // também enviamos 'scope' caso você queira usar depois
      fd.append("scope", "geral");

      const files = document.getElementById("images").files || [];
      for (let i=0;i<Math.min(files.length,5);i++){
        fd.append("images", files[i]);
      }

      addLine("Você", (document.getElementById("problem").value||"(vazio)"));
      try {
        const r = await fetch("/chat", { method: "POST", body: fd });
        const j = await r.json();
        if (!j.ok) {
          addLine("Assistente", "Falhou: " + (j.error||"erro desconhecido"));
        } else {
          addLine("Assistente", j.answer || j.reply || "(sem texto)");
        }
      } catch (e) {
        addLine("Assistente", "Erro de rede: " + e.message);
      }
    };
  </script>
</body>
</html>
