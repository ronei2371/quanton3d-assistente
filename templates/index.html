<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IA Quanton3D¬Æ ‚Äî Suporte t√©cnico 3D</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='site.css') }}">
</head>
<body>
  <!-- Faixa superior -->
  <header class="q3d-topbar">
    <div class="q3d-topbar__in">
      <div class="q3d-brand">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D" class="q3d-logo" onerror="this.style.display='none'">
        <div class="q3d-titlewrap">
          <h1 class="q3d-title">IA Quanton3D<sup>¬Æ</sup></h1>
          <div class="q3d-tagline">Suporte t√©cnico 3D</div>
        </div>
      </div>

      <div class="q3d-actions">
        <button class="q3d-ghost" id="btnShowTerms">Termos de uso</button>
        <button class="q3d-ghost" id="btnShowStory">Nossa hist√≥ria</button>
      </div>
    </div>
  </header>

  <main class="q3d-main">
    <div class="q3d-grid">
      <!-- Coluna esquerda: Formul√°rio -->
      <section class="q3d-card">
        <h2 class="q3d-h2">Identifica√ß√£o</h2>
        <p class="q3d-hint"><strong>O telefone identifica seu hist√≥rico.</strong> Use sempre o mesmo.</p>

        <form id="chatForm" autocomplete="off">
          <input type="hidden" name="scope" id="scope" value="desconhecido">

          <div class="q3d-field">
            <label for="phone" class="q3d-label">Telefone</label>
            <input type="tel" id="phone" name="phone" placeholder="11999999999" class="q3d-input" required>
          </div>

          <h3 class="q3d-h3">Par√¢metros de impress√£o Quanton3D</h3>
          <div class="q3d-two">
            <div class="q3d-field">
              <label for="resin" class="q3d-label">Resina</label>
              <input id="resin" name="resin" class="q3d-input" placeholder="Ex.: Spark">
            </div>

            <div class="q3d-field">
              <label for="printer" class="q3d-label">Impressora</label>
              <input id="printer" name="printer" class="q3d-input" placeholder="Ex.: Saturn 3">
              <!-- Se preferir, troque por <select id="printer"> e carregue printers.json -->
            </div>
          </div>

          <div class="q3d-field">
            <label for="problem" class="q3d-label q3d-biglabel">Descreva seu problema</label>
            <textarea id="problem" name="problem" rows="4" class="q3d-textarea" placeholder="Ex.: delamina√ß√£o entre camadas; primeira camada soltando; manchas no LCD..." required></textarea>
          </div>

          <div class="q3d-actionsline">
            <button type="submit" id="btnSend" class="q3d-primary">Enviar</button>
            <button type="button" id="btnReset" class="q3d-ghost">Limpar hist√≥rico</button>
          </div>

          <div class="q3d-field">
            <label class="q3d-label">Imagens (at√© 5 ‚Äî m√°x 3MB cada)</label>
            <input type="file" id="photos" name="photos" accept=".jpg,.jpeg,.png,.webp" multiple class="q3d-input-file">
            <div id="photoCount" class="q3d-hint">0 imagens selecionadas</div>
            <div class="q3d-hint">As imagens anexadas v√£o junto com a <u>pr√≥xima</u> pergunta.</div>
          </div>
        </form>
      </section>

      <!-- Coluna direita: Chat -->
      <section class="q3d-card">
        <h2 class="q3d-h2">Atendimento</h2>
        <div id="chatBox" class="q3d-chat"></div>
      </section>
    </div>
  </main>

  <!-- Rodap√© curto -->
  <footer class="q3d-footer">
    <div>¬© Quanton3D ‚Äî Conte√∫do exclusivo. Reprodu√ß√£o proibida sem autoriza√ß√£o.</div>
    <div class="q3d-muted">Vers√£o: {{ app_version }}</div>
  </footer>

  <!-- Modal: Termos -->
  <div class="q3d-modal" id="modalTerms" hidden>
    <div class="q3d-modal__backdrop"></div>
    <div class="q3d-modal__panel">
      <h3>üìå Termo de Uso ‚Äì Bot Quanton3D</h3>
      <ul class="q3d-ul">
        <li>O bot √© propriedade exclusiva da Quanton3D.</li>
        <li>Uso permitido apenas para suporte em impress√£o 3D.</li>
        <li>√â proibida a c√≥pia, modifica√ß√£o ou redistribui√ß√£o.</li>
        <li>As respostas s√£o apoio t√©cnico; n√£o substituem decis√µes profissionais.</li>
        <li>Viola√ß√£o implica bloqueio de acesso e medidas legais.</li>
      </ul>
      <label class="q3d-check">
        <input type="checkbox" id="chkAccept"> Li e aceito os Termos de Uso.
      </label>
      <div class="q3d-actionsline">
        <button class="q3d-primary" id="btnAccept" disabled>Aceito e continuar</button>
        <button class="q3d-ghost" id="btnCloseTerms">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal/Drawer: Nossa Hist√≥ria -->
  <div class="q3d-modal" id="modalStory" hidden>
    <div class="q3d-modal__backdrop"></div>
    <div class="q3d-modal__panel">
      <h3>Conhe√ßa a hist√≥ria de Nhor e filhos com Ronei</h3>
      <p>Um la√ßo de amor, trabalho e curiosidade ‚Äî a for√ßa por tr√°s da Quanton3D. üíô</p>
      <p>Se quiser, escreva aqui uma pergunta sobre nossa hist√≥ria que eu respondo com carinho.</p>
      <textarea id="storyAsk" rows="3" class="q3d-textarea" placeholder="Pergunte algo sobre nossa hist√≥ria..."></textarea>
      <div class="q3d-actionsline">
        <button class="q3d-ghost" id="btnCloseStory">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // ---- Termos: bloquear uso at√© aceitar (salvo no localStorage)
    const modalTerms = document.getElementById('modalTerms');
    const btnShowTerms = document.getElementById('btnShowTerms');
    const btnCloseTerms = document.getElementById('btnCloseTerms');
    const btnAccept = document.getElementById('btnAccept');
    const chkAccept = document.getElementById('chkAccept');

    function showTerms() { modalTerms.hidden = false; }
    function hideTerms() { modalTerms.hidden = true; }

    btnShowTerms.addEventListener('click', showTerms);
    btnCloseTerms.addEventListener('click', hideTerms);
    chkAccept.addEventListener('change', () => btnAccept.disabled = !chkAccept.checked);
    btnAccept.addEventListener('click', () => {
      localStorage.setItem('q3d_terms', '1');
      hideTerms();
    });

    if (localStorage.getItem('q3d_terms') !== '1') {
      showTerms();
    }

    // ---- Hist√≥ria
    const modalStory = document.getElementById('modalStory');
    const btnShowStory = document.getElementById('btnShowStory');
    const btnCloseStory = document.getElementById('btnCloseStory');
    btnShowStory.addEventListener('click', () => modalStory.hidden = false);
    btnCloseStory.addEventListener('click', () => modalStory.hidden = true);

    // ---- Form & Chat
    const form = document.getElementById('chatForm');
    const phone = document.getElementById('phone');
    const resin = document.getElementById('resin');
    const printer = document.getElementById('printer');
    const problem = document.getElementById('problem');
    const photos = document.getElementById('photos');
    const photoCount = document.getElementById('photoCount');
    const btnSend = document.getElementById('btnSend');
    const btnReset = document.getElementById('btnReset');
    const chatBox = document.getElementById('chatBox');

    photos.addEventListener('change', () => {
      const n = photos.files?.length || 0;
      photoCount.textContent = n + (n === 1 ? " imagem selecionada" : " imagens selecionadas");
    });

    function appendMsg(role, text) {
      const item = document.createElement('div');
      item.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      item.innerHTML = (role==='user' ? '<div class="who">Voc√™</div>' : '<div class="who">Assistente Quanton3D</div>') +
                       '<div class="bubble">' + (text||'').replace(/\n/g,'<br>') + '</div>';
      chatBox.appendChild(item);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    btnReset.addEventListener('click', async () => {
      if (!phone.value.trim()) { alert('Informe o telefone para limpar o hist√≥rico deste n√∫mero.'); return; }
      try {
        await fetch(`/reset?phone=${encodeURIComponent(phone.value.trim())}`);
        chatBox.innerHTML = '';
        appendMsg('bot', 'Hist√≥rico limpo para o telefone informado. Pode continuar!');
      } catch (e) {
        appendMsg('bot', 'N√£o consegui limpar agora. Tente novamente.');
      }
    });

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      if (localStorage.getItem('q3d_terms') !== '1') {
        showTerms();
        return;
      }
      if (!phone.value.trim()) { alert('Informe o telefone.'); return; }
      if (!problem.value.trim()) { alert('Descreva o problema.'); return; }

      btnSend.disabled = true;
      appendMsg('user', problem.value.trim());

      const fd = new FormData();
      fd.append('phone', phone.value.trim());
      fd.append('scope', document.getElementById('scope').value);
      fd.append('resin', resin.value.trim());
      fd.append('printer', printer.value.trim());
      fd.append('problem', problem.value.trim());

      // anexos
      if (photos.files && photos.files.length) {
        for (let i=0; i<Math.min(photos.files.length, 5); i++) {
          fd.append('photos', photos.files[i]);
        }
      }

      try {
        const r = await fetch('/chat', { method: 'POST', body: fd });
        const data = await r.json();
        if (!data.ok) {
          appendMsg('bot', 'Erro: ' + (data.error || 'Falha ao responder.'));
        } else {
          appendMsg('bot', data.reply || data.answer || '(sem texto)');
        }
      } catch (err) {
        appendMsg('bot', 'Conex√£o falhou. Tente novamente.');
      } finally {
        btnSend.disabled = false;
        // mantenho o texto para permitir conversa cont√≠nua; limpe as fotos
        photos.value = '';
        photoCount.textContent = '0 imagens selecionadas';
        problem.focus();
      }
    });

    // (Opcional) Carregar lista de impressoras de /static/printers.json se existir
    fetch('{{ url_for("static_files", filename="printers.json") }}')
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(list => {
        // se quiser mudar para <select>, adapte aqui.
        // por ora, s√≥ sugere via datalist:
        const dl = document.createElement('datalist');
        dl.id = 'printersList';
        (list || []).forEach(name => {
          const o = document.createElement('option');
          o.value = name;
          dl.appendChild(o);
        });
        document.body.appendChild(dl);
        printer.setAttribute('list','printersList');
      })
      .catch(()=>{ /* silencioso se n√£o existir */ });
  </script>
</body>
</html>
