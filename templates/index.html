<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QUANTON3D — Suporte Técnico SLA/DLP</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1520cc;
      --muted:#8aa0b2;
      --text:#e9f1f7;
      --brand:#39e1a2;
      --brand-2:#53a8ff;
      --danger:#ff6b6b;
      --ok:#65ffa8;
      --ring: 0 0 0 2px color-mix(in srgb, var(--brand) 60%, transparent);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:
        radial-gradient(1200px 600px at 80% -20%, #1b2632 15%, transparent 60%),
        radial-gradient(1200px 600px at 10% -30%, #15202b 10%, transparent 60%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 1px, transparent 1px 80px),
        linear-gradient(#0b0f14, #0b0f14);
      color:var(--text);
      letter-spacing:.2px;
    }
    a{color:var(--brand-2);text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{
      max-width:1120px;
      margin:32px auto;
      padding:0 16px 56px;
    }

    .header{
      display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:20px
    }
    .brand{
      display:flex;align-items:center;gap:14px
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background: linear-gradient(135deg,var(--brand),var(--brand-2));
      display:grid;place-items:center;color:#002a1e;font-weight:900;
      box-shadow: var(--shadow);
    }
    .title{font-weight:800;font-size:22px}
    .version{
      font-size:12px;color:var(--muted);padding:4px 10px;border:1px solid #203040;border-radius:999px
    }
    .actions{display:flex;gap:10px}
    .btn{
      border:1px solid #223243;background:#0f1520;color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600
    }
    .btn:hover{border-color:#38556e}
    .btn-brand{
      background:linear-gradient(135deg,var(--brand-2),var(--brand));border:none;color:#041015;
    }
    .btn-brand:hover{filter:brightness(1.05)}
    .btn-ghost{background:#101620;border:1px solid #26374a}
    .grid{
      display:grid;grid-template-columns: 1.1fr .9fr;gap:18px
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);backdrop-filter: blur(10px);
      border:1px solid #1c2733;border-radius:var(--radius);box-shadow:var(--shadow)
    }
    .card .hd{
      padding:16px 18px;border-bottom:1px solid #1b2a38;display:flex;justify-content:space-between;align-items:center
    }
    .card .bd{padding:18px}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    .row-1{display:grid;grid-template-columns:1fr;gap:12px}
    @media (max-width:720px){ .row, .row-3{grid-template-columns:1fr} }

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .in{
      width:100%;padding:12px 12px 12px 12px;border-radius:12px;
      background:#0d131b;border:1px solid #1f2e3d;color:var(--text);
      outline:none
    }
    .in:focus{box-shadow:var(--ring);border-color:#29506b}
    textarea.in{min-height:110px;resize:vertical}

    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px}
    .sp{flex:1}
    .small{font-size:12px;color:var(--muted)}

    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{
      width:84px;height:84px;border-radius:12px;background:#0a0f14;border:1px dashed #29445a;
      display:grid;place-items:center;overflow:hidden
    }
    .thumb img{width:100%;height:100%;object-fit:cover}

    .timeline{display:flex;flex-direction:column;gap:10px;max-height:640px;overflow:auto;padding:12px}
    .bubble{
      padding:12px 14px;border-radius:14px;border:1px solid #203041;background:#0d1218
    }
    .bubble.me{background:#0a1216;border-color:#21424e}
    .bubble.ai{background:#0f161f;border-color:#24445a}
    .tag{display:inline-block;padding:2px 8px;border:1px solid #264059;border-radius:999px;color:#9fc1d6;font-size:12px}
    .empty{color:#7c92a4;font-size:14px;padding:6px}

    .footer{margin-top:20px;color:#7faac0;font-size:13px}
    .hr{border-top:1px solid #1b2a38;margin:8px 0 14px}
    .pill{padding:6px 10px;border-radius:999px;background:#0c131a;border:1px solid #213445;color:#b6d2e2;font-size:12px}

    .spin{width:16px;height:16px;border-radius:50%;border:2px solid #1f2f3f;border-top-color:var(--brand);display:inline-block;animation:spin .8s linear infinite;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .quick{
      display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px
    }
    @media (max-width:980px){ .quick{grid-template-columns:1fr} }
    .qcard{border:1px solid #223244;border-radius:12px;padding:12px;background:#0c131a}
    .qcard h4{margin:0 0 6px;font-size:14px}
    .qcard ul{margin:0;padding-left:18px}
    .qcard li{color:#9eb5c6;font-size:13px;margin:6px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo">Q3</div>
        <div>
          <div class="title">QUANTON3D® — Suporte Técnico SLA/DLP</div>
          <div class="small">Atendimento prático e certeiro. <span class="pill">v {{ app_version or "local" }}</span></div>
        </div>
      </div>
      <div class="actions">
        <a class="btn btn-ghost" href="#" onclick="alert('Em breve ✨');return false;">Nossa história</a>
        <a class="btn btn-ghost" href="#" onclick="alert('Direitos reservados QUANTON3D®');return false;">Direitos autorais</a>
      </div>
    </div>

    <div class="grid">
      <!-- FORM -->
      <div class="card">
        <div class="hd">
          <div>Atendimento técnico</div>
          <div class="version">Use sempre o mesmo telefone — liga as conversas.</div>
        </div>
        <div class="bd">
          <form id="f" enctype="multipart/form-data" onsubmit="return false;">
            <div class="row">
              <div>
                <label>Telefone (WhatsApp)</label>
                <input class="in" name="phone" id="phone" placeholder="31 98334-0053" required />
              </div>
              <div>
                <label>Escopo</label>
                <select class="in" name="scope" id="scope">
                  <option value="geral">Geral</option>
                  <option value="lcd">Na tela (LCD)</option>
                  <option value="fatiamento">Fatiamento</option>
                  <option value="mecanica">Mecânica</option>
                  <option value="resina">Resina</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Resina (opcional)</label>
                <input class="in" name="resin" id="resin" placeholder="Ex.: ALCHEMIST ELEGOO / FlexForm..." />
                <div class="hint">Preencha para salvar suas configs no histórico.</div>
              </div>
              <div>
                <label>Impressora (opcional)</label>
                <input class="in" name="printer" id="printer" placeholder="Ex.: Anycubic Mono 4K / Saturn 3..." />
              </div>
            </div>

            <div class="row-1">
              <div>
                <label>Descreva o problema</label>
                <textarea class="in" name="problem" id="problem" placeholder="Explique em 1 frase. Ex.: 'Peça rachando no meio' ou 'LCD com faixas claras'." required></textarea>
              </div>
            </div>

            <div class="row-1">
              <div>
                <label>Imagens (JPG/PNG/WEBP, máx 5 — 3MB cada)</label>
                <input class="in" type="file" name="photos" id="photos" multiple accept="image/*" />
                <div class="thumbs" id="thumbs"></div>
                <div class="hint">Fotos ajudam MUITO para LCD, adesão e suportes.</div>
              </div>
            </div>

            <div class="toolbar">
              <div class="sp"></div>
              <a class="btn" id="btnHealth" href="/healthz" target="_blank" rel="noopener">Saúde</a>
              <a class="btn" id="btnDiag" href="/diag" target="_blank" rel="noopener">Diag</a>
              <button class="btn btn-ghost" id="btnReset" type="button" title="Limpa o histórico deste telefone">Reset</button>
              <button class="btn btn-brand" id="btnSend" type="submit">Enviar</button>
            </div>
          </form>

          <div class="hr"></div>

          <div class="quick">
            <div class="qcard">
              <h4>LCD — Modo certeiro</h4>
              <ul>
                <li>Papel branco: ver faixas → difusor/LED</li>
                <li>Grade/pixels: linhas apagadas → LCD</li>
                <li>Limpeza: microfibra + IPA (sem encharcar)</li>
              </ul>
            </div>
            <div class="qcard">
              <h4>Adesão & base</h4>
              <ul>
                <li>Base nivelada e limpa</li>
                <li>Camadas de base suficientes</li>
                <li>Elevação mais lenta se soltar</li>
              </ul>
            </div>
            <div class="qcard">
              <h4>Suportes</h4>
              <ul>
                <li>Ângulos suaves e densidade adequada</li>
                <li>Refaça ilhas e pontos fracos</li>
                <li>Teste rápido com peça simples</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="card">
        <div class="hd">
          <div>Respostas</div>
          <div class="small">
            <span class="tag">conversa contínua por telefone</span>
          </div>
        </div>
        <div class="bd">
          <div id="tl" class="timeline">
            <div class="empty">Sem mensagens ainda. Envie sua primeira pergunta acima. 🙂</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Conte com o time QUANTON3D; seguimos com você até dar certo. •
      <a href="#" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">voltar ao topo</a>
    </div>
  </div>

  <script>
    const el = (id)=>document.getElementById(id);
    const tl = el('tl');
    const thumbs = el('thumbs');
    const phone = el('phone');
    const scope = el('scope');
    const resin = el('resin');
    const printer = el('printer');
    const problem = el('problem');
    const photos = el('photos');
    const btnSend = el('btnSend');
    const btnReset = el('btnReset');

    // Previews
    photos.addEventListener('change', ()=>{
      thumbs.innerHTML = '';
      [...photos.files].slice(0,5).forEach(f=>{
        const d = document.createElement('div');
        d.className='thumb';
        const img = document.createElement('img');
        d.appendChild(img);
        thumbs.appendChild(d);
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        reader.readAsDataURL(f);
      });
    });

    function addBubble(role, text){
      const b = document.createElement('div');
      b.className = 'bubble ' + (role==='me'?'me':'ai');
      b.innerText = text;
      tl.querySelector('.empty')?.remove();
      tl.appendChild(b);
      tl.scrollTop = tl.scrollHeight;
    }

    // Reset conversas
    btnReset.addEventListener('click', ()=>{
      const p = (phone.value||'').replace(/\D/g,'');
      if(!p){ alert('Informe o telefone para resetar.'); return; }
      if(!confirm('Limpar histórico deste telefone?')) return;
      window.open(`/reset?phone=${encodeURIComponent(p)}`,'_blank');
    });

    // Enviar
    document.getElementById('f').addEventListener('submit', async ()=>{
      const p = phone.value.trim();
      const text = problem.value.trim();
      if(!p || !text){ alert('Preencha telefone e problema.'); return; }

      addBubble('me', text);
      const label = btnSend.innerHTML;
      btnSend.innerHTML = '<span class="spin"></span> Enviando...';
      btnSend.disabled = true;

      try{
        const fd = new FormData();
        fd.append('phone', p);
        fd.append('scope', scope.value);
        fd.append('resin', resin.value);
        fd.append('printer', printer.value);
        fd.append('problem', text);
        // arquivos (máx 5)
        [...photos.files].slice(0,5).forEach(f => fd.append('photos', f));

        const r = await fetch('/chat', { method: 'POST', body: fd });
        const js = await r.json().catch(()=>({ok:false,error:'Erro ao ler resposta.'}));

        if(js.ok){
          addBubble('ai', js.reply || js.answer || '(sem conteúdo)');
        }else{
          addBubble('ai', '⚠️ ' + (js.error || 'Falha ao processar. Tente novamente.'));
        }
      }catch(e){
        addBubble('ai', '⚠️ Erro de rede: ' + e.message);
      }finally{
        btnSend.innerHTML = label;
        btnSend.disabled = false;
      }
    });
  </script>
</body>
</html>
