<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IA Quanton3D ‚Äî Suporte t√©cnico 3D</title>
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='site.css') }}">
<style>
:root{--primary:#0bb7ff;--bg:#0b1220;--card:#121a2a}
body{background:#0b1220;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:#eaf1ff}
#topbar{background:linear-gradient(90deg,#0c6df7,#1ac8ff);height:76px;display:flex;align-items:center;padding:0 16px;box-shadow:0 2px 20px rgba(0,0,0,.25)}
#topbar h1{margin:0;font-size:1.25rem;font-weight:800;letter-spacing:.5px;color:#fff;line-height:1.1}
#topbar .brand{display:flex;align-items:center;gap:.65rem}
#topbar .brand img{width:32px;height:32px;border-radius:8px}
#navbtns{margin-left:auto;display:flex;gap:.5rem}
#navbtns .chip{background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.24);padding:.4rem .75rem;border-radius:999px;font-size:.85rem;cursor:pointer;text-decoration:none}
.container{max-width:980px;margin:22px auto;padding:0 16px}
.card{background:var(--card);border:1px solid #1e2a44;border-radius:14px;padding:16px;color:#cad5ff}
label{display:block;font-weight:600;margin:.35rem 0 .25rem}
input,select,textarea{width:100%;background:#0f1626;color:#eaf1ff;border:1px solid #26324f;border-radius:10px;padding:.75rem}
textarea{min-height:140px;resize:vertical}
.actions{display:flex;align-items:center;gap:.5rem;margin-top:10px}
button.primary{background:var(--primary);color:#041423;border:0;border-radius:999px;padding:.7rem 1.2rem;font-weight:800;cursor:pointer}
small.muted{color:#95a3c7}

/* BLOQUEIO (gate obrigat√≥rio) */
#gate-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);z-index:1000;display:none}
#gate{position:fixed;z-index:1001;inset:0;display:none;align-items:center;justify-content:center}
#gate .box{width:min(680px,92vw);background:#0f182a;color:#eaf1ff;border:1px solid #21406a;border-radius:16px;padding:18px}
#gate h2{margin:0 0 8px;font-size:1.15rem}
#gate ul{margin:.5rem 0 1rem 1.1rem}
#gate .row{display:flex;align-items:center;gap:.5rem}
#gate button{margin-left:auto}

/* MODAL ‚ÄúNossa hist√≥ria‚Äù */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:900;display:none}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:901}
.modal .box{width:min(720px,92vw);background:#0f182a;color:#eaf1ff;border:1px solid #20466f;border-radius:16px;padding:18px}
.modal .row{display:flex;gap:.5rem;margin-top:.75rem}
.modal button{white-space:nowrap}
</style>
</head>
<body>

<header id="topbar">
  <div class="brand">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D">
    <h1>IA Quanton3D¬Æ<br><small style="font-weight:600;opacity:.85">Suporte t√©cnico 3D</small></h1>
  </div>
  <div id="navbtns">
    <a href="#" class="chip" id="btn-terms">Termos de uso</a>
    <a href="#" class="chip" id="btn-story">Nossa hist√≥ria</a>
    <span class="chip">v {{ app_version }}</span>
  </div>
</header>

<main class="container">
  <form id="chat-form" class="card" enctype="multipart/form-data">
    <h3 style="margin:0 0 8px">Identifica√ß√£o</h3>
    <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
      <div>
        <label>Telefone (WhatsApp)</label>
        <input id="phone" name="phone" placeholder="(31) 9 0000-0000" required>
        <small class="muted">Use sempre o mesmo telefone ‚Äî ele vincula seu hist√≥rico.</small>
      </div>
      <div>
        <label>Onde est√° o problema?</label>
        <select id="scope" name="scope" required>
          <option value="" selected>Selecione...</option>
          <option value="lcd">LCD / backlight</option>
          <option value="adesao">Primeira camada</option>
          <option value="delaminacao">Delamina√ß√£o</option>
          <option value="outros">Outros</option>
        </select>
      </div>
    </div>

    <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr;margin-top:8px">
      <div>
        <label>Resina (opcional ‚Äî cat√°logo em breve)</label>
        <input id="resin" name="resin" placeholder="Ex.: Spark / Alchemist / Flex...">
      </div>
      <div>
        <label>Impressora (opcional ‚Äî cat√°logo em breve)</label>
        <input id="printer" name="printer" placeholder="Ex.: Anycubic Photon Mono X, Elegoo Saturn...">
      </div>
    </div>

    <label style="margin-top:10px">Descreva o problema</label>
    <textarea id="problem" name="problem" placeholder="Ex.: delamina√ß√£o entre camadas; primeira camada soltando; manchas no LCD..." required></textarea>

    <label style="margin-top:10px">Imagens (JPG/PNG/WEBP, m√°x 5 ‚Äî 3MB cada)</label>
    <input type="file" id="images" name="images" accept=".jpg,.jpeg,.png,.webp" multiple>
    <small class="muted">Dica: foto da tela acesa ajuda muito nos casos de LCD/backlight.</small>

    <div class="actions">
      <label style="display:flex;align-items:center;gap:.45rem;margin:0">
        <input id="tos-check" type="checkbox">
        <span>Li e aceito os <a href="#" id="inline-terms">termos de uso</a> e a <a href="/privacidade" target="_blank">pol√≠tica de privacidade</a>.</span>
      </label>
      <button id="send" class="primary" type="submit" disabled>Enviar</button>
      <a id="reset-hist" class="chip" href="#" style="margin-left:auto;text-decoration:none">Reset do meu hist√≥rico</a>
    </div>

    <div id="answer" class="card" style="margin-top:14px;display:none"></div>
  </form>
</main>

<!-- GATE (obrigat√≥rio aceitar) -->
<div id="gate-backdrop"></div>
<div id="gate" role="dialog" aria-modal="true">
  <div class="box">
    <h2>üìå Termos de Uso ‚Äì Bot Quanton3D</h2>
    <p>Antes de continuar, leia e concorde:</p>
    <ul>
      <li>O bot √© propriedade exclusiva da Quanton3D.</li>
      <li>Uso permitido apenas para suporte t√©cnico de impress√£o 3D.</li>
      <li>Proibida a c√≥pia, modifica√ß√£o ou redistribui√ß√£o.</li>
      <li>As respostas s√£o apoio t√©cnico e n√£o substituem decis√µes profissionais.</li>
      <li>Viola√ß√£o pode implicar bloqueio de acesso e medidas legais.</li>
    </ul>
    <div class="row">
      <label style="display:flex;align-items:center;gap:.5rem">
        <input id="gate-check" type="checkbox"> <span>Li e concordo com os termos acima.</span>
      </label>
      <button id="gate-accept" class="primary" disabled>Concordo e continuar</button>
    </div>
  </div>
</div>

<!-- MODAL ‚ÄúNossa hist√≥ria‚Äù -->
<div id="story-backdrop" class="modal-backdrop"></div>
<div id="story" class="modal" role="dialog" aria-modal="true" aria-labelledby="story-title">
  <div class="box">
    <h2 id="story-title">Conhe√ßa a hist√≥ria de Nhor e filhos com Ronei</h2>
    <p>Um la√ßo de amor, trabalho e curiosidade ‚Äî a for√ßa por tr√°s da Quanton3D. üíô</p>
    <label>Se quiser, deixe sua pergunta que eu respondo com carinho:</label>
    <textarea id="story-q" placeholder="Digite sua pergunta aqui..." rows="3"></textarea>
    <div class="row">
      <button id="story-close">Fechar</button>
      <button id="story-send" class="primary">Enviar</button>
    </div>
    <div id="story-ans" class="card" style="margin-top:10px;display:none"></div>
  </div>
</div>

<script>
const TOS_KEY = "q3d_tos_v1";

// Gate (bloqueio)
function showGate(){document.getElementById('gate-backdrop').style.display='block';document.getElementById('gate').style.display='flex'}
function hideGate(){document.getElementById('gate-backdrop').style.display='none';document.getElementById('gate').style.display='none'}
function initGate(){
  const accepted = localStorage.getItem(TOS_KEY)==='1';
  const tosInline = document.getElementById('tos-check');
  const sendBtn = document.getElementById('send');

  tosInline.checked = false;       // nunca vem marcado
  sendBtn.disabled = true;         // come√ßa travado

  if(!accepted){ showGate(); }     // se nunca aceitou, bloqueia a p√°gina

  // l√≥gica do gate
  const gateCk = document.getElementById('gate-check');
  const gateAccept = document.getElementById('gate-accept');
  gateCk.addEventListener('change',()=>{ gateAccept.disabled = !gateCk.checked; });
  gateAccept.addEventListener('click',()=>{
    localStorage.setItem(TOS_KEY,'1');
    tosInline.checked = true;      // marca a caixa inline
    sendBtn.disabled = false;      // libera envio
    hideGate();
  });

  // reabrir termos pelos links
  document.getElementById('btn-terms').addEventListener('click',(e)=>{e.preventDefault();showGate();});
  document.getElementById('inline-terms').addEventListener('click',(e)=>{e.preventDefault();showGate();});

  // se desmarcar a caixa inline, trava de novo
  tosInline.addEventListener('change',()=>{ sendBtn.disabled = !tosInline.checked; });

  // reset do hist√≥rico (precisa do telefone)
  document.getElementById('reset-hist').addEventListener('click',(e)=>{
    e.preventDefault();
    const phone = document.getElementById('phone').value.trim();
    if(!phone){ alert('Informe seu telefone antes de resetar.'); return; }
    fetch(`/reset?phone=${encodeURIComponent(phone)}`).then(()=>alert('Hist√≥rico apagado para este telefone.'));
  });
}

// Envio principal
document.getElementById('chat-form').addEventListener('submit',async (e)=>{
  e.preventDefault();
  const fd = new FormData();
  fd.append('phone',document.getElementById('phone').value.trim());
  fd.append('scope',document.getElementById('scope').value);
  fd.append('resin',document.getElementById('resin').value.trim());
  fd.append('printer',document.getElementById('printer').value.trim());
  fd.append('problem',document.getElementById('problem').value.trim());
  const files = document.getElementById('images').files;
  for(let i=0;i<Math.min(files.length,5);i++){ fd.append('images',files[i]); }
  const res = await fetch('/chat',{method:'POST',body:fd});
  const data = await res.json();
  const box = document.getElementById('answer');
  box.style.display='block';
  box.textContent = data.ok ? (data.reply || data.answer || '(sem texto)') : ('Erro: '+(data.error||'desconhecido'));
});

// Modal ‚ÄúNossa hist√≥ria‚Äù
function openStory(){document.getElementById('story-backdrop').style.display='block';document.getElementById('story').style.display='flex'}
function closeStory(){document.getElementById('story-backdrop').style.display='none';document.getElementById('story').style.display='none'}
document.getElementById('btn-story').addEventListener('click',openStory);
document.getElementById('story-close').addEventListener('click',closeStory);

document.getElementById('story-send').addEventListener('click',async ()=>{
  const q = document.getElementById('story-q').value.trim();
  const phone = document.getElementById('phone').value.trim();
  if(!q){ alert('Digite sua pergunta.'); return; }
  if(!phone){ alert('Informe seu telefone na p√°gina principal primeiro.'); return; }
  const fd = new FormData();
  fd.append('phone',phone);
  fd.append('scope','historia');
  fd.append('resin','');
  fd.append('printer','');
  fd.append('problem',q);
  const res = await fetch('/chat',{method:'POST',body:fd});
  const data = await res.json();
  const ans = document.getElementById('story-ans');
  ans.style.display='block';
  ans.textContent = data.ok ? (data.reply || data.answer || '(sem texto)') : ('Erro: '+(data.error||'desconhecido'));
});

document.addEventListener('DOMContentLoaded',initGate);
</script>
</body>
</html>
