<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Quanton3D</title>
  <link rel="icon" href="/static/logo.png" />
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --ink:#eaf1ff; --muted:#9fb0d0; --brand:#2dd4bf; --danger:#ef4444; --ok:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--ink);}
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:980px; margin:auto; padding:16px;}
    header{display:flex; align-items:center; gap:12px; padding:12px 0 16px}
    header img{height:40px; width:auto}
    h1{margin:0; font-size:20px; font-weight:700}
    .note{font-size:12px; color:var(--muted)}
    .grid{display:grid; gap:12px}
    .card{background:var(--card); border:1px solid #1f2b45; border-radius:14px; padding:14px}
    label{display:block; font-size:14px; margin-bottom:6px}
    .bigger{font-size:15px; font-weight:700}
    input, select, textarea{width:100%; padding:12px; border-radius:10px; border:1px solid #2a395d; background:#0f172a; color:var(--ink)}
    textarea{min-height:110px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }
    .actions{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button{padding:10px 14px; border-radius:10px; border:1px solid #2a395d; background:#0f172a; color:var(--ink); cursor:pointer}
    button.primary{background:var(--brand); color:#04221e; border-color:transparent; font-weight:700}
    button.danger{background:#220b0b; border-color:#541b1b; color:#ffd1d1}
    .switch{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}
    .small{font-size:12px; color:var(--muted)}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #2a395d; color:var(--muted)}
    .resp{display:flex; flex-direction:column; gap:10px}
    .msg{background:#0f172a; border:1px solid #223055; border-radius:12px; padding:12px}
    .msg h4{margin:0 0 6px 0; font-size:13px; color:#a8b9db}
    .ok{color:var(--ok)}
    .err{color:#ff9aa3}
    .copyright{font-size:12px; color:#b7c5e6}
    .toast{position:fixed; right:12px; bottom:12px; background:#091225; border:1px solid #1e2b4b; color:#dbe7ff; padding:10px 12px; border-radius:10px; display:none}
    .hint{font-size:12px; color:#95a6c9; margin-top:-4px; margin-bottom:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/static/logo.png" alt="Quanton3D" />
      <div>
        <h1>Assistente T√©cnico Quanton3D</h1>
        <div class="note">v<span id="ver">{{ app_version or "" }}</span> ‚Ä¢ O telefone identifica seu hist√≥rico. <b>Use sempre o mesmo.</b></div>
      </div>
      <div style="margin-left:auto" class="pill">Servi√ßo oficial</div>
    </header>

    <div class="card grid">
      <div class="row">
        <div>
          <label class="bigger" for="phone">Telefone do cliente</label>
          <input id="phone" type="tel" placeholder="11999999999" />
          <div class="hint">O hist√≥rico fica atrelado a este n√∫mero.</div>
        </div>
        <div class="switch">
          <input id="keep" type="checkbox" checked />
          <label for="keep">Manter conversa (hist√≥rico deste telefone)</label>
        </div>
      </div>

      <div>
        <div class="bigger" style="margin-bottom:4px">Par√¢metros de impress√£o Quanton3D</div>
        <div class="hint">Preencha para obter <b>par√¢metros oficiais</b> da resina impressora (quando quiser). N√£o √© obrigat√≥rio para diagnosticar defeitos.</div>
        <div class="row">
          <div>
            <label for="resin">Resina</label>
            <input id="resin" type="text" placeholder="Ex.: Spark" />
          </div>
          <div>
            <label for="printer">Impressora</label>
            <input id="printer" type="text" placeholder="Ex.: Saturn 3" />
          </div>
        </div>
      </div>

      <div>
        <label class="bigger" for="problem">Descreva seu problema</label>
        <textarea id="problem" placeholder="Ex.: Delamina√ß√£o entre camadas na metade da pe√ßa..."></textarea>
      </div>

      <div class="actions">
        <button id="send" class="primary">Enviar d√∫vida</button>
        <button id="reset" class="danger" title="Zera o hist√≥rico deste telefone">Novo assunto (zerar conversa)</button>
        <span id="status" class="small"></span>
      </div>

      <div>
        <label for="images">Imagens (opcional, at√© 5 ‚Äî m√°x 3MB cada)</label>
        <input id="images" type="file" accept="image/png,image/jpeg,image/webp" multiple />
      </div>
    </div>

    <div style="height:8px"></div>

    <div class="card">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px">
        <div class="bigger">Respostas</div>
        <span class="pill">novas no topo</span>
      </div>
      <div id="resp" class="resp"></div>
    </div>

    <div style="height:10px"></div>

    <div class="card">
      <div class="copyright">
        üìú Todo o conte√∫do gerado por este assistente √© de uso exclusivo da empresa detentora da marca <b>Quanton3D¬Æ</b>.<br/>
        Esta IA segue diretrizes t√©cnicas e estilo da marca. √â proibida a reprodu√ß√£o sem autoriza√ß√£o. Tentativas de c√≥pia indevida podem gerar a√ß√£o legal (Lei n¬∫ 9.279/96).<br/>
        Para uso autorizado ou parcerias, contate nosso time üíô
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const el = s => document.querySelector(s);
    const phoneEl   = el('#phone');
    const keepEl    = el('#keep');
    const resinEl   = el('#resin');
    const printerEl = el('#printer');
    const probEl    = el('#problem');
    const imagesEl  = el('#images');
    const respEl    = el('#resp');
    const statusEl  = el('#status');
    const toastEl   = el('#toast');

    // ‚Äî‚Äî‚Äî util
    function toast(msg, ok=true){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 2500); }
    function prependMsg(title, body, cls=''){
      const box = document.createElement('div');
      box.className = 'msg';
      box.innerHTML = `<h4>${title}</h4><div class="${cls}">${body.replace(/\n/g,'<br/>')}</div>`;
      respEl.prepend(box);
    }

    // ‚Äî‚Äî‚Äî lembrar telefone no navegador do cliente
    const LS_KEY = 'quanton3d_phone';
    const savedPhone = localStorage.getItem(LS_KEY);
    if(savedPhone){ phoneEl.value = savedPhone; }
    phoneEl.addEventListener('change', ()=> localStorage.setItem(LS_KEY, phoneEl.value.replace(/\D+/g,'') ));

    // ‚Äî‚Äî‚Äî enviar d√∫vida
    el('#send').addEventListener('click', async ()=>{
      const phone = (phoneEl.value||'').trim();
      const problem = (probEl.value||'').trim();
      if(!phone){ toast('Informe o telefone.', false); phoneEl.focus(); return; }
      if(!problem){ toast('Descreva o problema.', false); probEl.focus(); return; }

      const fd = new FormData();
      fd.append('phone', phone);
      fd.append('scope', 'desconhecido');
      fd.append('resin', (resinEl.value||'').trim());
      fd.append('printer', (printerEl.value||'').trim());
      fd.append('problem', problem);
      fd.append('continue', keepEl.checked ? '1':'0');

      const files = imagesEl.files || [];
      if(files.length>5){ toast('M√°ximo 5 imagens.', false); return; }
      for(let i=0;i<files.length;i++){ fd.append('images', files[i]); }

      statusEl.textContent = 'Enviando...';
      try{
        const r = await fetch('/chat', { method:'POST', body: fd });
        const j = await r.json();
        if(!j.ok){
          prependMsg('Erro', j.error || 'Falha ao responder.', 'err');
        }else{
          const cls = j.classification ? `(${j.classification}) ` : '';
          const title = `Assistente ${cls}‚Ä¢ imagens: ${j.images||0}`;
          const body  = (j.answer||'').trim() || '(sem texto)';
          prependMsg(title, body);
          // limpa apenas problema e imagens (mant√©m telefone e prefer√™ncias)
          // probEl.value = ''; // se quiser limpar a caixa, descomente
          imagesEl.value = '';
        }
      }catch(e){
        prependMsg('Erro', String(e), 'err');
      }finally{
        statusEl.textContent = '';
      }
    });

    // ‚Äî‚Äî‚Äî reset (novo assunto)
    el('#reset').addEventListener('click', async ()=>{
      const phone = (phoneEl.value||'').trim();
      if(!phone){ toast('Informe o telefone para resetar o assunto.', false); phoneEl.focus(); return; }
      if(!confirm('Zerar a conversa deste telefone? Isso n√£o apaga seus arquivos.')) return;
      try{
        const r = await fetch(`/reset?phone=${encodeURIComponent(phone)}`);
        const j = await r.json();
        if(j && j.ok){
          toast('Assunto zerado. Pode come√ßar um tema novo!');
          prependMsg('Sistema', 'Assunto zerado para este telefone.', 'ok');
        }else{
          toast('N√£o foi poss√≠vel zerar agora.', false);
        }
      }catch(e){
        toast('Falha ao conectar.', false);
      }
    });
  </script>
</body>
</html>
