<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IA Quanton3D ‚Äî Suporte T√©cnico SLA/DLP</title>

  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='site.css') }}">

  <meta name="theme-color" content="#0B1020">
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar__left">
      <img class="brand__logo" src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D">
      <div>
        <div class="brand__title">IA Quanton3D<sup>¬Æ</sup></div>
        <div class="brand__subtitle">Suporte t√©cnico 3D (SLA/DLP)</div>
      </div>
    </div>
    <nav class="topbar__right">
      <a class="chip" href="#" id="btnHistory">Nossa hist√≥ria</a>
      <a class="chip chip--muted" href="#" id="btnCopyright">Direitos autorais</a>
    </nav>
  </header>

  <!-- Conte√∫do -->
  <main class="container">
    <section class="card">
      <h1 class="card__title">Atendimento t√©cnico</h1>

      <!-- ALERTA -->
      <div id="alert" class="alert hidden"></div>

      <!-- Form principal -->
      <form id="chatForm" class="grid" autocomplete="off">
        <!-- Telefone -->
        <div class="field field--full">
          <label for="phone">üì± WhatsApp (use sempre o mesmo n√∫mero)</label>
          <input id="phone" name="phone" type="tel" placeholder="(31) 9 0000-0000" required>
          <small>O telefone identifica o seu hist√≥rico de atendimento.</small>
        </div>

        <!-- Problema -->
        <div class="field field--full">
          <label for="problem">üõ†Ô∏è Descreva seu problema</label>
          <textarea id="problem" name="problem" rows="4" placeholder="Ex.: delamina√ß√£o entre camadas; primeira camada n√£o gruda; manchas no LCD‚Ä¶" required></textarea>
        </div>

        <!-- Campos de par√¢metros (opcionais, para usar quando quiser par√¢metros de resina/impressora) -->
        <div class="field">
          <label for="resin">Par√¢metros Quanton3D ‚Äî Resina</label>
          <input id="resin" name="resin" type="text" placeholder="Ex.: Spark / Alchemist / Marfim">
          <small>Preencha para obter par√¢metros da sua resina (opcional).</small>
        </div>

        <div class="field">
          <label for="printer">Par√¢metros Quanton3D ‚Äî Impressora</label>
          <input id="printer" name="printer" type="text" placeholder="Ex.: Saturn 3 / Mars 3 / Photon M3">
          <small>Preencha para obter par√¢metros para sua m√°quina (opcional).</small>
        </div>

        <!-- Fotos -->
        <div class="field field--full">
          <label for="images">üì∑ Imagens (opcional, at√© 5 ‚Äî m√°x. 3MB cada)</label>
          <input id="images" name="images" type="file" accept="image/*" multiple>
          <small id="imgCount">0 imagens selecionadas</small>
        </div>

        <!-- Termos -->
        <div class="field field--full tos-check">
          <input id="tos" type="checkbox">
          <label for="tos">Li e aceito os <a href="#" id="openTOS">Termos de Uso</a>.</label>
        </div>

        <!-- A√ß√µes -->
        <div class="actions field--full">
          <button type="button" class="btn ghost" id="btnClear">Limpar</button>
          <button type="button" class="btn ghost" id="btnDownload">Baixar hist√≥rico (.txt)</button>
          <button type="submit" class="btn primary" id="btnSend">Enviar</button>
        </div>
      </form>

      <!-- Feed -->
      <div id="feed" class="feed" aria-live="polite" aria-busy="false"></div>

      <footer class="legal">
        <div>¬© Quanton3D<sup>¬Æ</sup> ‚Ä¢ Todos os direitos reservados.</div>
        <div class="muted">Vers√£o {{ app_version }}</div>
      </footer>
    </section>
  </main>

  <!-- Modal Termos -->
  <div id="modalTOS" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="tosTitle">
    <div class="modal-box">
      <h2 id="tosTitle">üìå Termo de Uso ‚Äì Bot Quanton3D</h2>
      <div class="modal-body scroll">
        <p>‚úÖ Ao continuar, voc√™ declara que:</p>
        <ul>
          <li>Reconhece que o bot √© propriedade exclusiva da Quanton3D;</li>
          <li>O uso √© permitido apenas para suporte em impress√£o 3D;</li>
          <li>√â proibida a c√≥pia, modifica√ß√£o ou redistribui√ß√£o;</li>
          <li>As informa√ß√µes s√£o apoio t√©cnico e n√£o substituem decis√µes profissionais;</li>
          <li>Viola√ß√£o implica em bloqueio de acesso e medidas legais.</li>
        </ul>
      </div>
      <div class="modal-actions">
        <label style="display:flex;align-items:center;gap:.5rem;">
          <input id="tosModalChk" type="checkbox"> Li e aceito os termos acima
        </label>
        <div style="display:flex;gap:.5rem;">
          <button class="btn ghost" id="tosCancel">Sair</button>
          <button class="btn primary" id="tosAccept">Aceito e Continuar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Hist√≥ria -->
  <div id="modalHistory" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="modal-box">
      <h2 id="histTitle">üíô Nossa hist√≥ria</h2>
      <div class="modal-body scroll">
        <p>Este espa√ßo √© nosso ‚Äî Nhor, Ronei e filhos ‚Äî para guardar um resumo de carinho e uni√£o. Se quiser, me envie um arquivo .txt depois para eu colocar aqui bonitinho.</p>
        <textarea id="histQuestion" rows="3" placeholder="Fa√ßa uma pergunta sobre nossa hist√≥ria (opcional)‚Ä¶"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="histClose">Fechar</button>
        <button class="btn primary" id="histAsk">Perguntar</button>
      </div>
    </div>
  </div>

  <script>
    // --- util
    const $ = (s) => document.querySelector(s);
    const feed = $("#feed");
    const alertBox = $("#alert");
    const LS_KEY_TOS = "q3d_tos_ok";
    const LS_KEY_HISTORY = "q3d_hist_" // + phone

    function showAlert(msg, kind="error") {
      alertBox.textContent = msg;
      alertBox.classList.remove("hidden");
      alertBox.classList.toggle("ok", kind === "ok");
      alertBox.classList.toggle("error", kind !== "ok");
    }
    function clearAlert(){ alertBox.classList.add("hidden"); }

    function addBubble(text, who="you") {
      const div = document.createElement("div");
      div.className = "bubble " + (who === "you" ? "you" : "bot");
      div.textContent = text;
      feed.appendChild(div);
      feed.scrollTop = feed.scrollHeight;
    }

    // --- termos: bloqueia na primeira visita
    function ensureTOS() {
      const ok = localStorage.getItem(LS_KEY_TOS) === "1";
      if (!ok) {
        $("#modalTOS").classList.remove("hidden");
      } else {
        $("#tos").checked = true;
      }
    }
    $("#openTOS").addEventListener("click", (e)=>{ e.preventDefault(); $("#modalTOS").classList.remove("hidden"); });
    $("#tosCancel").onclick = ()=>{ location.href="about:blank"; };
    $("#tosAccept").onclick = ()=>{
      if (!$("#tosModalChk").checked) { return; }
      localStorage.setItem(LS_KEY_TOS, "1");
      $("#tos").checked = true;
      $("#modalTOS").classList.add("hidden");
    };

    // --- hist√≥ria
    $("#btnHistory").onclick = (e)=>{ e.preventDefault(); $("#modalHistory").classList.remove("hidden"); };
    $("#histClose").onclick = ()=> $("#modalHistory").classList.add("hidden");
    $("#histAsk").onclick = async ()=>{
      const phone = $("#phone").value.trim();
      const txt = ($("#histQuestion").value||"").trim();
      if (!phone) { showAlert("Informe o telefone para salvar seu hist√≥rico."); return; }
      if (!txt) { $("#modalHistory").classList.add("hidden"); return; }
      addBubble("[HIST√ìRIA] " + txt, "you");
      await sendToBot({ phone, resin:"", printer:"", problem: "[HIST√ìRIA] " + txt, images: [] });
      $("#histQuestion").value = "";
      $("#modalHistory").classList.add("hidden");
    };

    // --- contagem de imagens
    $("#images").addEventListener("change", (e)=>{
      $("#imgCount").textContent = (e.target.files?.length || 0) + " imagens selecionadas";
    });

    // --- limpar / baixar
    $("#btnClear").onclick = ()=>{
      $("#problem").value = "";
      $("#images").value = "";
      $("#imgCount").textContent = "0 imagens selecionadas";
      clearAlert();
      feed.innerHTML = "";
    };
    $("#btnDownload").onclick = ()=>{
      const parts = [];
      document.querySelectorAll(".bubble").forEach(b=>{
        const who = b.classList.contains("you") ? "Voc√™" : "Assistente";
        parts.push(who + ":\n" + b.textContent + "\n");
      });
      const blob = new Blob([parts.join("\n")], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "historico_quanton3d.txt";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };

    // --- envio principal
    $("#chatForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearAlert();

      if (!$("#tos").checked) {
        showAlert("Voc√™ precisa aceitar os Termos de Uso para continuar.");
        return;
      }

      const phone = $("#phone").value.trim();
      const resin = $("#resin").value.trim();
      const printer = $("#printer").value.trim();
      const problem = $("#problem").value.trim();
      if (!phone || !problem) {
        showAlert("Informe telefone e descreva o problema.");
        return;
      }

      addBubble(problem, "you");
      $("#btnSend").disabled = true;

      try {
        await sendToBot({ phone, resin, printer, problem, images: Array.from($("#images").files || []) });
      } catch (err) {
        showAlert(String(err||"Falha ao enviar.")); 
      } finally {
        $("#btnSend").disabled = false;
      }
    });

    async function sendToBot({ phone, resin, printer, problem, images }) {
      const fd = new FormData();
      fd.append("phone", phone);
      fd.append("resin", resin);
      fd.append("printer", printer);
      fd.append("problem", problem);
      (images||[]).slice(0,5).forEach(f => fd.append("images", f));

      const r = await fetch("/chat", { method:"POST", body: fd });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok || !data.ok) {
        throw (data?.error || ("Erro " + r.status));
      }
      addBubble(data.answer || data.reply || "(sem resposta)", "bot");
    }

    // init
    ensureTOS();
  </script>
<!-- Modal de Termos de Uso -->
<div id="modalTOS" role="dialog" aria-modal="true" aria-labelledby="tosTitle">
  <div class="box">
    <h3 id="tosTitle">Termos de uso ‚Äì Bot Quanton3D</h3>
    <ul>
      <li>O bot √© propriedade exclusiva da Quanton3D.</li>
      <li>Uso permitido apenas para suporte em impress√£o 3D.</li>
      <li>√â proibida a c√≥pia, modifica√ß√£o ou redistribui√ß√£o.</li>
      <li>As informa√ß√µes s√£o apoio t√©cnico e n√£o substituem decis√µes profissionais.</li>
      <li>Viola√ß√£o implica bloqueio e medidas legais.</li>
    </ul>

    <label class="tos-check">
      <input type="checkbox" id="tosCheck"> Li e concordo com os termos de uso e a pol√≠tica de privacidade.
    </label>

    <div class="actions">
      <button type="button" id="btnTOSClose">Fechar</button>
      <button type="button" id="btnTOSAgree" disabled>Aceito e continuar</button>
    </div>
  </div>
</div>

<script>
  // For√ßa exibir at√© aceitar
  const LS_KEY_TOS = "q3d_tos_ok_v2"; // mudei a chave pra for√ßar de novo se precisar
  const modal   = document.getElementById('modalTOS');
  const chk     = document.getElementById('tosCheck');
  const agree   = document.getElementById('btnTOSAgree');
  const closeBt = document.getElementById('btnTOSClose');

  function openTOS(){ modal.classList.add('open'); document.body.style.overflow='hidden'; }
  function closeTOS(){ modal.classList.remove('open'); document.body.style.overflow=''; }

  if (!localStorage.getItem(LS_KEY_TOS)) openTOS();

  chk?.addEventListener('change', () => { agree.disabled = !chk.checked; });
  agree?.addEventListener('click', () => { localStorage.setItem(LS_KEY_TOS,'1'); closeTOS(); });
  closeBt?.addEventListener('click', closeTOS);
</script>

</body>
</html>
