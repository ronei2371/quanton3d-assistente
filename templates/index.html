<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUANTON3D ‚Äî Suporte T√©cnico SLA/DLP</title>

  <!-- Favicon oficial -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" sizes="32x32" />
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" sizes="192x192" />
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}"/>

  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#2a3442; --line:#243040;
      --brand:#06c3ff; --brand2:#28e1ff; --text:#e9f0f8; --text-dim:#9bb0c9; --ok:#2ed573; --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 600px at 10% -10%, #0c1723 10%, var(--bg) 60%),
      radial-gradient(900px 500px at 110% -20%, #072c3e 10%, transparent 60%), var(--bg);
      color:var(--text); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:970px; margin:24px auto 56px; padding:0 16px}
    header{
      display:flex; align-items:center; gap:14px; margin:8px 0 22px;
    }
    header img.logo{width:44px; height:44px; border-radius:10px; background:#000; box-shadow:0 0 0 2px #0b0b0b, 0 0 18px rgba(0, 195, 255,.3)}
    header .ttl{font-weight:700; letter-spacing:.3px}
    header .ver{color:var(--text-dim); font-size:.85rem; padding:.15rem .5rem; border:1px solid var(--line); border-radius:999px}

    .card{background:linear-gradient(180deg, rgba(6,28,38,.45), rgba(9,18,28,.45)), var(--panel);
      border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.25); padding:18px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .grid-1{display:grid; grid-template-columns:1fr; gap:14px}
    label{font-size:.9rem; color:var(--text-dim)}
    input[type="text"], textarea, select{
      width:100%; background:#0f1520; color:var(--text); border:1px solid #1d2734; outline:none;
      padding:12px 12px; border-radius:12px; transition:.15s; caret-color:var(--brand);
    }
    input::placeholder, textarea::placeholder{color:#7f96b1}
    input:focus, textarea:focus, select:focus{border-color:var(--brand)}
    textarea{min-height:120px; resize:vertical}
    .hint{font-size:.8rem; color:var(--text-dim)}
    .bar{display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px}
    .btn{
      appearance:none; border:0; padding:12px 18px; border-radius:12px; cursor:pointer; font-weight:600;
      color:#001018; background:linear-gradient(180deg, var(--brand2), var(--brand)); box-shadow:0 8px 24px rgba(6,195,255,.25);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-out{
      background:transparent; color:var(--text); border:1px solid var(--line)
    }
    .resp{margin-top:16px; padding:14px; border-radius:12px; border:1px dashed var(--line); background:#0b121b}
    .resp .me{opacity:.9; margin:10px 0 2px; color:#c7d6ea; font-size:.92rem}
    .resp .ai{margin:6px 0 14px; white-space:pre-wrap}
    .muted{color:var(--text-dim)}
    .links{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{font-size:.8rem; padding:.15rem .5rem; border-radius:999px; border:1px solid var(--line); color:var(--text-dim)}
    .ok{color:var(--ok)} .err{color:var(--err)}

    /* Modal Termos */
    .modal-back{position:fixed; inset:0; background:rgba(5,10,16,.7); backdrop-filter:blur(3px); display:none; align-items:center; justify-content:center; z-index:1000}
    .modal{width:min(680px, 92vw); background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:20px}
    .modal h3{margin:0 0 10px}
    .ul{margin:10px 0 14px 20px}
    .ul li{margin:6px 0}
    .tos-row{display:flex; align-items:center; gap:10px; margin-top:8px}
    .tiny{font-size:.82rem; color:var(--text-dim)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D">
      <div>
        <div class="ttl">QUANTON3D¬Æ ‚Äî Suporte T√©cnico SLA/DLP</div>
        <div class="links">
          <span class="chip">v {{ app_version }}</span>
          <a class="chip" href="{{ url_for('static', filename='direitos-autorais.txt') }}" target="_blank" rel="noopener">Direitos autorais</a>
          <a class="chip" href="{{ url_for('static', filename='privacidade.txt') }}" target="_blank" rel="noopener">Privacidade</a>
        </div>
      </div>
      <div style="flex:1"></div>
      <span class="ver">Modo Certeiro</span>
    </header>

    <section class="card">
      <form id="f" class="grid-1" enctype="multipart/form-data" autocomplete="on">
        <div class="grid">
          <div>
            <label>Telefone (WhatsApp)</label>
            <input type="text" name="phone" id="phone" placeholder="(31) 9 0000-0000" required>
            <div class="hint">Use sempre o mesmo telefone ‚Äî ele vincula seu hist√≥rico.</div>
          </div>
          <div>
            <label>Onde est√° o problema?</label>
            <select name="scope" id="scope">
              <option value="desconhecido">Selecione‚Ä¶</option>
              <option value="lcd">Na tela (LCD)</option>
              <option value="geral">Geral (ades√£o/suportes/exposi√ß√£o)</option>
              <option value="mecanico">Mec√¢nico (eixo Z/FEP)</option>
              <option value="eletronica">Eletr√¥nica/Luzes</option>
            </select>
          </div>
        </div>

        <div class="grid">
          <div>
            <label>Resina (opcional ‚Äî cat√°logo Quanton3D em breve)</label>
            <input type="text" name="resin" id="resin" placeholder="Ex.: Q3D Dental / Flex / Tough‚Ä¶">
          </div>
          <div>
            <label>Impressora (opcional ‚Äî cat√°logo em breve)</label>
            <input type="text" name="printer" id="printer" placeholder="Ex.: Anycubic Photon Mono X, Elegoo Saturn‚Ä¶">
          </div>
        </div>

        <div>
          <label>Descreva o problema</label>
          <textarea name="problem" id="problem" placeholder="Explique o que est√° acontecendo‚Ä¶"></textarea>
        </div>

        <div>
          <label>Imagens (JPG/PNG/WEBP, m√°x 5 ‚Äî 3MB cada)</label>
          <input type="file" id="photos" name="photos" accept=".jpg,.jpeg,.png,.webp" multiple />
          <div class="hint">Dica: foto da tela acesa ajuda MUITO nos casos de LCD/backlight.</div>
        </div>

        <div class="bar">
          <button type="button" class="btn-out" id="btnReset">Reset do meu hist√≥rico</button>
          <button type="submit" class="btn" id="btnSend">Enviar</button>
        </div>
      </form>

      <div id="resp" class="resp" hidden>
        <div class="me muted" id="me"></div>
        <div class="ai" id="ai"></div>
      </div>
    </section>

    <p class="tiny" style="margin-top:12px">Conte com o time QUANTON3D; seguimos com voc√™ at√© dar certo.</p>
  </div>

  <!-- Modal de Termos -->
  <div class="modal-back" id="tosBack">
    <div class="modal">
      <h3>üìå Termos de Uso ‚Äî Bot Quanton3D</h3>
      <ul class="ul">
        <li>Voc√™ reconhece que o bot √© propriedade exclusiva da <b>Quanton3D</b>.</li>
        <li>Uso permitido apenas para suporte em impress√£o 3D.</li>
        <li>√â proibida a c√≥pia, modifica√ß√£o ou redistribui√ß√£o.</li>
        <li>As respostas s√£o apoio t√©cnico e <b>n√£o substituem</b> decis√µes profissionais.</li>
        <li>Viola√ß√£o implica em bloqueio de acesso e medidas legais.</li>
      </ul>
      <label class="tos-row"><input type="checkbox" id="tosCheck"> Li e aceito os Termos de Uso.</label>
      <div class="bar" style="justify-content:space-between">
        <a class="tiny" href="{{ url_for('static', filename='privacidade.txt') }}" target="_blank" rel="noopener">Pol√≠tica de Privacidade</a>
        <button class="btn" id="tosGo" disabled>Aceito e continuar</button>
      </div>
    </div>
  </div>

  <script>
    const qs = (s)=>document.querySelector(s);
    const me = qs('#me'), ai = qs('#ai'), resp = qs('#resp');
    const btnSend = qs('#btnSend'); const frm = qs('#f');
    const tosBack = qs('#tosBack'); const tosGo = qs('#tosGo'); const tosCheck = qs('#tosCheck');
    const TOS_KEY = 'q3d_tos_v1';

    // Modal Termos
    function showTos(){ tosBack.style.display='flex' }
    function hideTos(){ tosBack.style.display='none' }
    if(!localStorage.getItem(TOS_KEY)) showTos();
    tosCheck.addEventListener('change', ()=>{ tosGo.disabled = !tosCheck.checked; });
    tosGo.addEventListener('click', ()=>{
      localStorage.setItem(TOS_KEY, 'true');
      hideTos();
    });

    // Reset do hist√≥rico
    qs('#btnReset').addEventListener('click', ()=>{
      const phone = qs('#phone').value.trim();
      if(!phone){ alert('Digite seu telefone para resetar seu hist√≥rico.'); return; }
      location.href = `/reset?phone=${encodeURIComponent(phone)}`;
    });

    // Envio
    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!localStorage.getItem(TOS_KEY)){ showTos(); return; }

      btnSend.disabled = true;

      const fd = new FormData();
      fd.append('phone', qs('#phone').value.trim());
      fd.append('scope', qs('#scope').value);
      fd.append('resin', qs('#resin').value.trim());
      fd.append('printer', qs('#printer').value.trim());
      fd.append('problem', qs('#problem').value.trim());
      fd.append('tos_ok', 'true');

      const files = qs('#photos').files;
      for(let i=0; i<Math.min(files.length,5); i++){
        if(files[i].size > 3*1024*1024){ alert(`Imagem ${i+1} excede 3MB.`); btnSend.disabled=false; return; }
        fd.append('photos', files[i]); // <- campo que o backend espera
      }

      me.textContent = `Voc√™: ${qs('#problem').value.trim() || '(sem texto)'}`;
      resp.hidden = false;
      ai.innerHTML = '<span class="muted">Processando‚Ä¶</span>';

      try{
        const r = await fetch('/chat', { method:'POST', body: fd });
        const j = await r.json();
        if(!j.ok){ ai.innerHTML = `<span class="err">Erro: ${j.error||'falha inesperada'}</span>`; }
        else{
          ai.textContent = j.reply || j.answer || '(sem resposta)';
        }
      }catch(err){
        ai.innerHTML = `<span class="err">Erro de rede.</span>`;
      }finally{
        btnSend.disabled = false;
      }
    });
  </script>
</body>
</html>
