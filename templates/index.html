<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IA Quanton3D ‚Äî Suporte T√©cnico 3D</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='site.css') }}">
</head>
<body>
  <!-- Cabe√ßalho -->
  <header class="topbar">
    <div class="topbar__inner">
      <img class="brand__logo" src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D" />
      <div class="brand__texts">
        <h1 class="brand__title">IA Quanton3D<span class="reg">¬Æ</span></h1>
        <p class="brand__subtitle">Suporte T√©cnico 3D</p>
      </div>
      <div class="topbar__spacer"></div>
      <a class="link--terms" href="#" id="openTOS">Termos de Uso</a>
    </div>
  </header>

  <!-- Conte√∫do -->
  <main class="container">
    <section class="card">
      <h2 class="card__title">Abrir diagn√≥stico</h2>

      <form id="form" class="form" enctype="multipart/form-data">
        <!-- campo oculto para termos -->
        <input type="hidden" name="tos_accept" id="tos_accept" value="0" />

        <div class="grid">
          <div class="field col-12">
            <label for="phone" class="label label--big">Telefone (sempre o mesmo)</label>
            <input id="phone" name="phone" type="tel" inputmode="numeric" placeholder="Ex.: 5531999999999" class="input" />
            <p class="hint">O telefone identifica seu hist√≥rico. Use sempre o mesmo.</p>
          </div>

          <div class="field col-12">
            <label for="problem" class="label label--big">Descreva seu problema</label>
            <textarea id="problem" name="problem" rows="4" class="textarea" placeholder="Conte o que aconteceu (ex.: delamina√ß√£o, falha na primeira camada, manchas, etc.)"></textarea>
          </div>

          <!-- Par√¢metros (opcional) -->
          <div class="field col-12">
            <button type="button" class="btn btn--ghost" id="toggleParams">
              Par√¢metros Quanton3D (opcional)
              <span class="chev" id="chev">‚ñº</span>
            </button>
            <div id="paramsBox" class="params hide">
              <div class="grid">
                <div class="field col-6">
                  <label for="brand" class="label">Marca da impressora</label>
                  <select id="brand" class="select">
                    <option value="">Selecione (opcional)</option>
                  </select>
                </div>
                <div class="field col-6">
                  <label for="printer" class="label">Modelo da impressora</label>
                  <select id="printerSelect" class="select">
                    <option value="">Selecione (opcional)</option>
                  </select>
                </div>
                <div class="field col-12">
                  <label for="resin" class="label">Resina</label>
                  <input id="resin" name="resin" type="text" class="input" placeholder="Ex.: Spark, Alchemist (opcional)" />
                </div>
              </div>
            </div>
            <!-- o backend espera name="printer"; vamos preencher a partir do select -->
            <input type="hidden" name="printer" id="printerHidden" value="">
          </div>

          <div class="field col-12">
            <label for="images" class="label">Imagens (opcional, at√© 5 ‚Äî m√°x 3MB cada)</label>
            <input id="images" name="images" type="file" class="input" accept="image/*" multiple />
          </div>

          <div class="actions col-12">
            <button type="submit" class="btn btn--primary" id="sendBtn">Enviar</button>
            <button type="button" class="btn btn--muted" id="clearBtn">Limpar</button>
          </div>
        </div>
      </form>
    </section>

    <section class="card" id="chatCard">
      <h2 class="card__title">Respostas</h2>
      <div id="chat" class="chat"></div>
    </section>
  </main>

  <!-- Rodap√© -->
  <footer class="footer">
    <p>üìú Todo o conte√∫do gerado por este assistente √© de uso exclusivo da empresa detentora da marca Quanton3D¬Æ.
    √â proibida a reprodu√ß√£o, c√≥pia ou clonagem sem autoriza√ß√£o. Para uso autorizado ou parcerias, entre em contato com nosso time üíô</p>
  </footer>

  <!-- Modal de Termos (bloqueia at√© aceitar) -->
  <div id="modalTOS" class="modal hidden" aria-hidden="true">
    <div class="modal__backdrop"></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="tosTitle">
      <div class="modal__header">
        <h3 id="tosTitle">Termo de Uso ‚Äì Bot Quanton3D</h3>
      </div>
      <div class="modal__body">
        <ul class="tos-list">
          <li>Voc√™ reconhece que o bot √© propriedade exclusiva da Quanton3D;</li>
          <li>O uso √© permitido apenas para suporte em impress√£o 3D;</li>
          <li>√â proibida a c√≥pia, modifica√ß√£o ou redistribui√ß√£o;</li>
          <li>As informa√ß√µes s√£o apoio t√©cnico e n√£o substituem decis√µes profissionais;</li>
          <li>Viola√ß√£o implica em bloqueio de acesso e medidas legais.</li>
        </ul>
        <label class="check">
          <input type="checkbox" id="tosCheck" />
          <span>Li e concordo com os Termos de Uso da Quanton3D</span>
        </label>
      </div>
      <div class="modal__footer">
        <button id="acceptTOS" class="btn btn--primary" disabled>Aceito e continuar</button>
      </div>
    </div>
  </div>

  <script>
  // -------- Helpers UI --------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  // Termos de Uso
  const modalTOS = $('#modalTOS');
  const tosCheck = $('#tosCheck');
  const acceptTOS = $('#acceptTOS');
  const tosInput = $('#tos_accept');
  const openTOS = $('#openTOS');

  function showTOS() {
    modalTOS.classList.remove('hidden');
    document.body.classList.add('noscroll');
  }
  function hideTOS() {
    modalTOS.classList.add('hidden');
    document.body.classList.remove('noscroll');
  }

  // Exibir TOS se ainda n√£o aceitou
  const TOS_KEY = 'q3d_tos_ok';
  if (!localStorage.getItem(TOS_KEY)) {
    showTOS();
  } else {
    tosInput.value = '1';
  }

  tosCheck.addEventListener('change', () => {
    acceptTOS.disabled = !tosCheck.checked;
  });
  acceptTOS.addEventListener('click', () => {
    localStorage.setItem(TOS_KEY, '1');
    tosInput.value = '1';
    hideTOS();
  });
  openTOS.addEventListener('click', (e) => {
    e.preventDefault();
    showTOS();
  });

  // Toggle Par√¢metros
  const toggleParams = $('#toggleParams');
  const paramsBox = $('#paramsBox');
  const chev = $('#chev');
  toggleParams.addEventListener('click', () => {
    paramsBox.classList.toggle('hide');
    chev.textContent = paramsBox.classList.contains('hide') ? '‚ñº' : '‚ñ≤';
  });

  // Impressoras ‚Äî carrega de /static/printers.json (se existir); sen√£o usa fallback
  const brandSel = $('#brand');
  const modelSel = $('#printerSelect');
  const printerHidden = $('#printerHidden');

  const fallbackPrinters = [
    {"brand":"ELEGOO","model":"MARS"},
    {"brand":"ELEGOO","model":"MARS 2 PRO"},
    {"brand":"ELEGOO","model":"MARS 3"},
    {"brand":"ELEGOO","model":"SATURN"},
    {"brand":"ELEGOO","model":"SATURN 2"},
    {"brand":"ELEGOO","model":"SATURN 3"},
    {"brand":"ELEGOO","model":"SATURN 3 ULTRA"},
    {"brand":"ELEGOO","model":"SATURN 4 ULTRA"},
    {"brand":"Anycubic","model":"Photon Mono"},
    {"brand":"Anycubic","model":"Photon M3"},
    {"brand":"Creality","model":"Halot One"}
  ];
  let printers = [];

  async function loadPrinters() {
    try {
      const res = await fetch('{{ url_for("static_files", filename="printers.json") }}');
      if (!res.ok) throw new Error('no printers.json');
      printers = await res.json();
    } catch {
      printers = fallbackPrinters;
    }
    // popula marcas
    const brands = [...new Set(printers.map(p => p.brand))].sort();
    brands.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b;
      opt.textContent = b;
      brandSel.appendChild(opt);
    });
  }

  function fillModels(brand) {
    modelSel.innerHTML = '<option value="">Selecione (opcional)</option>';
    if (!brand) return;
    printers.filter(p => p.brand === brand).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.model;
      opt.textContent = p.model;
      modelSel.appendChild(opt);
    });
  }

  brandSel.addEventListener('change', () => {
    fillModels(brandSel.value);
    printerHidden.value = '';
  });
  modelSel.addEventListener('change', () => {
    printerHidden.value = modelSel.value ? (brandSel.value + ' ' + modelSel.value) : '';
  });

  loadPrinters();

  // Envio do formul√°rio
  const form = $('#form');
  const chat = $('#chat');
  const sendBtn = $('#sendBtn');
  const clearBtn = $('#clearBtn');

  function addMsg(text, who='assistant') {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (who === 'user' ? 'msg--user' : 'msg--bot');
    wrap.innerHTML = text.replace(/\n/g,'<br>');
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  clearBtn.addEventListener('click', () => {
    chat.innerHTML = '';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // valida m√≠nimos
    const phone = $('#phone').value.trim();
    const problem = $('#problem').value.trim();
    if (!phone) { alert('Informe o telefone.'); return; }
    if (!problem) { alert('Descreva o problema.'); return; }
    if (tosInput.value !== '1') { showTOS(); return; }

    // prepara dados
    const fd = new FormData(form);
    // garante que printer (hidden) esteja atualizado
    fd.set('printer', printerHidden.value);

    // UI
    sendBtn.disabled = true;
    addMsg(`<b>Voc√™:</b> ${problem}`, 'user');

    try {
      const res = await fetch('/chat', { method: 'POST', body: fd });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        const msg = data && (data.error || data.message) ? (data.error || data.message) : 'Erro ao processar sua solicita√ß√£o.';
        addMsg(`<b>Erro:</b> ${msg}`, 'assistant');
      } else {
        const reply = data.answer || data.reply || '(sem conte√∫do)';
        addMsg(`<b>Assistente:</b> ${reply}`, 'assistant');
      }
    } catch (err) {
      addMsg(`<b>Erro de rede:</b> ${String(err)}`, 'assistant');
    } finally {
      sendBtn.disabled = false;
    }
  });
  </script>
</body>
</html>
