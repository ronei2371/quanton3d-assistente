<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IA Quanton3D ‚Äî Suporte t√©cnico 3D</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='site.css') }}" />
</head>
<body>

  <!-- Topo fino e claro -->
  <header class="topbar">
    <div class="wrap topbar__content">
      <div class="brand">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D" class="brand__logo" />
        <div class="brand__text">
          <div class="brand__name">IA Quanton3D<span class="reg">¬Æ</span></div>
          <div class="brand__sub">Suporte t√©cnico 3D</div>
        </div>
      </div>

      <nav class="actions">
        <button class="chip" id="btnTos" type="button">Termos de uso</button>
        <button class="chip" id="btnStory" type="button">Nossa hist√≥ria</button>
        <span class="badge">v {{ app_version }}</span>
      </nav>
    </div>
  </header>

  <!-- Conte√∫do -->
  <main class="wrap">
    <section class="card">
      <h1 class="title">Identifica√ß√£o</h1>

      <form id="frm" class="grid" enctype="multipart/form-data">
        <!-- Coluna A -->
        <div class="col">
          <div class="field">
            <label class="label" for="phone">Telefone (WhatsApp)</label>
            <input id="phone" name="phone" class="input" placeholder="(31) 9 0000-0000" autocomplete="tel" />
            <small class="hint">Use sempre o mesmo telefone ‚Äî ele vincula seu hist√≥rico.</small>
          </div>

          <div class="field">
            <label class="label" for="resin">Resina (opcional ‚Äî cat√°logo Quanton3D em breve)</label>
            <input id="resin" name="resin" class="input" placeholder="Ex.: Spark / Alchemist / Flex..." />
          </div>

          <div class="field">
            <label class="label" for="problem">Descreva o problema</label>
            <textarea id="problem" name="problem" class="textarea" rows="6"
              placeholder="Ex.: delamina√ß√£o entre camadas; primeira camada soltando; manchas no LCD..."></textarea>
          </div>
        </div>

        <!-- Coluna B -->
        <div class="col">
          <div class="field">
            <label class="label" for="scope">Onde est√° o problema?</label>
            <select id="scope" name="scope" class="select">
              <option value="">Selecione...</option>
              <option>ades√£o/base</option>
              <option>suportes</option>
              <option>par√¢metros</option>
              <option>lavagem/p√≥s-cura</option>
              <option>lcd/tela/backlight</option>
              <option>outros</option>
            </select>
          </div>

          <div class="field">
            <label class="label" for="printer">Impressora (opcional ‚Äî cat√°logo em breve)</label>
            <input id="printer" name="printer" class="input" list="printersList"
                   placeholder="Ex.: Anycubic Photon Mono X, Elegoo Saturn..." />
            <datalist id="printersList"></datalist>
          </div>

          <div class="field">
            <label class="label">Imagens (JPG/PNG/WEBP, m√°x 5 ‚Äî 3MB cada)</label>
            <input id="photos" name="photos" class="input" type="file" accept=".jpg,.jpeg,.png,.webp" multiple />
            <small class="hint">Dica: foto da tela acesa ajuda MUITO nos casos de LCD/backlight.</small>
          </div>
        </div>

        <!-- Linha final -->
        <div class="row actions-row">
          <label class="check">
            <input type="checkbox" id="accept" />
            <span>Li e aceito os <a href="#" id="lnkTos">termos de uso</a> e a
              <a href="#" id="lnkPrivacy">pol√≠tica de privacidade</a>.</span>
          </label>

          <div class="buttons">
            <a class="link" id="resetLink" href="#" title="Limpa s√≥ o seu hist√≥rico">Reset do meu hist√≥rico</a>
            <button id="btnSend" class="btn btn-primary" type="submit" disabled>Enviar</button>
          </div>
        </div>
      </form>
    </section>

    <!-- Timeline de respostas -->
    <section id="feed" class="feed"></section>
  </main>

  <!-- Rodap√© com direitos -->
  <footer class="footer">
    <div class="wrap footer__content">
      <div>¬© QUANTON3D ‚Äî todos os direitos reservados</div>
      <div class="footer__links">
        <a href="#" id="ftTos">Direitos autorais</a>
        <span>‚Ä¢</span>
        <a href="#" id="ftPrivacy">Privacidade</a>
      </div>
    </div>
  </footer>

  <!-- Modal: Termos -->
  <div class="modal" id="modalTos" hidden>
    <div class="modal__box">
      <h2>Termo de Uso ‚Äì Bot Quanton3D</h2>
      <div class="modal__body">
        <ul class="legal">
          <li>O bot √© propriedade exclusiva da Quanton3D.</li>
          <li>Uso permitido apenas para suporte em impress√£o 3D.</li>
          <li>√â proibida a c√≥pia, modifica√ß√£o ou redistribui√ß√£o.</li>
          <li>As informa√ß√µes s√£o apoio t√©cnico e n√£o substituem decis√µes profissionais.</li>
          <li>Viola√ß√£o implica em bloqueio de acesso e medidas legais.</li>
        </ul>
      </div>
      <div class="modal__actions">
        <button class="btn btn-secondary" data-close>Fechar</button>
        <button class="btn btn-primary" id="agree">Aceito</button>
      </div>
    </div>
  </div>

  <!-- Modal: Privacidade (texto breve) -->
  <div class="modal" id="modalPrivacy" hidden>
    <div class="modal__box">
      <h2>Privacidade</h2>
      <div class="modal__body">
        Usamos os dados informados (telefone, descri√ß√£o e imagens) somente para
        realizar o suporte t√©cnico. N√£o vendemos seus dados. Para excluir, use
        ‚ÄúReset do meu hist√≥rico‚Äù.
      </div>
      <div class="modal__actions">
        <button class="btn btn-primary" data-close>Ok</button>
      </div>
    </div>
  </div>

  <!-- Modal: Nossa hist√≥ria -->
  <div class="modal" id="modalStory" hidden>
    <div class="modal__box">
      <h2>Conhe√ßa a hist√≥ria de Nhor e filhos com Ronei</h2>
      <div class="modal__body">
        <p>Um la√ßo de amor, trabalho e curiosidade ‚Äî a for√ßa por tr√°s da Quanton3D. üíô</p>
        <label class="label" for="story-input">Se quiser, deixe sua pergunta que eu respondo com carinho:</label>
        <textarea id="story-input" class="textarea" rows="4" placeholder="Ex.: Como nasceu a Quanton3D?"></textarea>
        <div id="story-output" class="story-output"></div>
      </div>
      <div class="modal__actions">
        <button class="btn btn-secondary" data-close>Fechar</button>
        <button class="btn btn-primary" id="sendStory">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    // util
    const $ = (sel) => document.querySelector(sel);
    const soDigitos = (s) => (s || '').replace(/\D/g, '');

    // habilita bot√£o ao aceitar
    const accept = $('#accept');
    const btnSend = $('#btnSend');
    accept.addEventListener('change', () => btnSend.disabled = !accept.checked);

    // modais
    function openModal(id){ const m=$(id); if(m) m.hidden=false; }
    function closeModals(){ document.querySelectorAll('.modal').forEach(m=>m.hidden=true); }
    document.addEventListener('click', (e)=>{
      if(e.target.matches('[data-close]') || e.target.classList.contains('modal')) closeModals();
    });

    // Termos & Privacidade (topo e rodap√©)
    $('#btnTos').onclick = () => openModal('#modalTos');
    $('#lnkTos').onclick = (e)=>{e.preventDefault(); openModal('#modalTos');};
    $('#ftTos').onclick  = (e)=>{e.preventDefault(); openModal('#modalTos');};
    $('#agree').onclick  = ()=>{ accept.checked = true; btnSend.disabled = false; closeModals(); };

    $('#lnkPrivacy').onclick = (e)=>{e.preventDefault(); openModal('#modalPrivacy');};
    $('#ftPrivacy').onclick  = (e)=>{e.preventDefault(); openModal('#modalPrivacy');};

    // Hist√≥ria
    $('#btnStory').onclick = ()=> openModal('#modalStory');
    $('#sendStory').onclick = async ()=>{
      const phone = soDigitos($('#phone').value) || 'anon';
      const q     = ($('#story-input').value || '').trim();
      const out   = $('#story-output');
      if(!q){ out.textContent = 'Escreva sua pergunta.'; return; }

      out.textContent = 'Enviando...';
      const fd = new FormData();
      fd.append('phone', phone);
      fd.append('question', q);

      try{
        const r = await fetch('/story', { method:'POST', body: fd });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Falha');
        out.textContent = j.answer || '(sem resposta)';
      }catch(err){
        out.textContent = 'Erro: ' + err.message;
      }
    };

    // Reset do hist√≥rico
    const resetA = $('#resetLink');
    resetA.onclick = (e)=>{
      e.preventDefault();
      const p = soDigitos($('#phone').value || '');
      if(!p){ alert('Informe o telefone na p√°gina primeiro.'); return; }
      window.open(`/reset?phone=${p}`, '_blank');
    };

    // Envio do suporte
    const frm = $('#frm');
    const feed = $('#feed');
    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!accept.checked){ openModal('#modalTos'); return; }

      const fd = new FormData();
      const phone = soDigitos($('#phone').value || '');
      const problem = ($('#problem').value || '').trim();
      if(!phone){ alert('Informe o telefone.'); return; }
      if(!problem){ alert('Descreva o problema.'); return; }

      fd.append('phone',   phone);
      fd.append('scope',   $('#scope').value || '');
      fd.append('resin',   $('#resin').value || '');
      fd.append('printer', $('#printer').value || '');
      fd.append('problem', problem);

      const files = $('#photos').files;
      for(let i=0;i<files.length && i<5;i++){ fd.append('photos', files[i]); }

      const card = document.createElement('div');
      card.className = 'msg';
      card.innerHTML = `<div class="msg__you"><b>Voc√™:</b> ${problem}</div><div class="msg__bot">Enviando...</div>`;
      feed.prepend(card);

      try{
        const r = await fetch('/chat', { method:'POST', body: fd });
        const j = await r.json();
        const bot = card.querySelector('.msg__bot');
        if(!j.ok) bot.textContent = 'Erro: ' + (j.error || 'Falha');
        else     bot.innerHTML    = `<b>Assistente:</b> ${j.reply || j.answer || '(sem resposta)'}`;
      }catch(err){
        card.querySelector('.msg__bot').textContent = 'Erro: ' + err.message;
      }
    });

    // sugere impressoras (se existir o arquivo)
    (async ()=>{
      try{
        const res = await fetch('{{ url_for("static", filename="printers.json") }}', {cache:'no-store'});
        if(!res.ok) return;
        const arr = await res.json();
        const dl = $('#printersList');
        arr.slice(0,500).forEach(v=>{
          const o=document.createElement('option'); o.value=v; dl.appendChild(o);
        });
      }catch(_){}
    })();
  </script>
</body>
</html>
