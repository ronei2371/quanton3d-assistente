<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IA Quanton3D — Suporte técnico 3D</title>

  <!-- favicon e estilos -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='site.css') }}">
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar__left">
      <img class="brand__logo" src="{{ url_for('static', filename='logo.png') }}" alt="Quanton3D">
      <div class="brand__text">
        <div class="brand__title">IA Quanton3D<span class="reg">®</span></div>
        <div class="brand__subtitle">Suporte técnico 3D • SLA/DLP</div>
      </div>
    </div>
    <div class="topbar__right">
      <a class="chip" href="#" data-open-tos>Termos de uso</a>
      <a class="chip" href="https://quanton3d.com.br" target="_blank" rel="noopener">Nossa história</a>
      <span class="chip chip--muted">v {{ app_version }}</span>
    </div>
  </header>

  <!-- Conteúdo -->
  <main class="container">
    <form id="form" class="card">
      <h2 class="card__title">Identificação</h2>

      <div class="grid">
        <div class="field">
          <label>Telefone (WhatsApp)</label>
          <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="(31) 9 0000-0000" required>
          <small>Use sempre o mesmo telefone — ele vincula seu histórico.</small>
        </div>

        <div class="field">
          <label>Onde está o problema?</label>
          <select id="scope" name="scope" required>
            <option value="" selected disabled>Selecione…</option>
            <option value="lcd">Tela (LCD / backlight / vazamento)</option>
            <option value="adesao">Adesão / primeira camada</option>
            <option value="suportes">Suportes / delaminação</option>
            <option value="config">Parâmetros e fatiamento</option>
            <option value="geral">Geral</option>
          </select>
        </div>

        <div class="field">
          <label>Resina (opcional — catálogo Quanton3D em breve)</label>
          <input id="resin" name="resin" placeholder="Ex.: Spark / Alchemist / Flex / Tough…">
        </div>

        <div class="field">
          <label>Impressora (opcional — catálogo em breve)</label>
          <input id="printer" name="printer" placeholder="Ex.: Anycubic Photon Mono X, Elegoo Saturn…">
        </div>

        <div class="field field--full">
          <label>Descreva o problema</label>
          <textarea id="problem" name="problem" rows="5" placeholder="Ex.: delaminação entre camadas; primeira camada soltando; manchas no LCD…" required></textarea>
        </div>

        <div class="field field--full">
          <label>Imagens (JPG/PNG/WEBP, máx 5 — 3MB cada)</label>
          <input id="photos" name="photos" type="file" multiple accept="image/jpeg,image/png,image/webp">
          <small>Dica: foto da tela acesa ajuda MUITO nos casos de LCD/backlight.</small>
        </div>
      </div>

      <label class="tos-check">
        <input id="accept" type="checkbox" />
        Li e aceito os <a href="#" data-open-tos>termos de uso</a> e a
        <a href="#" data-open-tos>política de privacidade</a>.
      </label>

      <div class="actions">
        <button id="btnReset" type="button" class="btn ghost" title="Limpa seu histórico local">Reset do meu histórico</button>
        <button id="btnSend" class="btn primary" disabled>Enviar</button>
      </div>

      <div id="feed" class="feed" hidden></div>
    </form>
  </main>

  <!-- Modal: Termos de uso -->
  <div class="modal" id="modalTos" hidden>
    <div class="modal-box">
      <h3>Termos de Uso – Quanton3D</h3>
      <div class="modal-body scroll" id="tosBody">
        <p>✅ Ao continuar, você declara que:</p>
        <ul>
          <li>Reconhece que o bot é propriedade exclusiva da Quanton3D.</li>
          <li>O uso é permitido apenas para suporte em impressão 3D.</li>
          <li>É proibida a cópia, modificação ou redistribuição.</li>
          <li>As informações são apoio técnico e não substituem decisões profissionais.</li>
          <li>Violação implica em bloqueio de acesso e medidas legais.</li>
        </ul>
        <p><strong>Privacidade:</strong> coletamos o telefone somente para vincular seu histórico. Não vendemos seus dados.</p>
      </div>
      <div class="modal-actions">
        <label style="display:flex;gap:.5rem;align-items:center">
          <input type="checkbox" id="tosRead">
          Li e concordo com os Termos de uso e a Política de Privacidade.
        </label>
        <div style="display:flex;gap:.5rem;justify-content:flex-end">
          <button type="button" class="btn" onclick="closeModals()">Fechar</button>
          <button type="button" id="agree" class="btn primary" disabled>Aceito e continuar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // util modal
    function openModal(sel){ document.querySelector(sel).hidden = false; document.body.classList.add('blocked'); }
    function closeModals(){ document.querySelectorAll('.modal').forEach(m=>m.hidden=true); document.body.classList.remove('blocked'); }

    // referencias
    const form    = document.querySelector('#form');
    const btnSend = document.querySelector('#btnSend');
    const btnReset= document.querySelector('#btnReset');
    const feed    = document.querySelector('#feed');
    const accept  = document.querySelector('#accept');
    const agree   = document.querySelector('#agree');
    const tosBody = document.querySelector('#tosBody');
    const tosRead = document.querySelector('#tosRead');

    // abrir termos de qualquer link
    document.querySelectorAll('[data-open-tos]').forEach(a=>{
      a.addEventListener('click', (e)=>{ e.preventDefault(); openModal('#modalTos'); });
    });

    // lógica de aceite
    const TOS_KEY = 'q3d_tos_v1';
    let scrolledToEnd = false;
    function updateAgree(){ agree.disabled = !(scrolledToEnd && tosRead.checked); }
    tosBody.addEventListener('scroll', ()=>{
      scrolledToEnd = tosBody.scrollTop + tosBody.clientHeight >= tosBody.scrollHeight - 8;
      updateAgree();
    });
    tosRead.addEventListener('change', updateAgree);

    agree.addEventListener('click', ()=>{
      localStorage.setItem(TOS_KEY, '1');
      accept.checked = true;
      btnSend.disabled = false;
      closeModals();
    });

    window.addEventListener('load', ()=>{
      if (!localStorage.getItem(TOS_KEY)) {
        btnSend.disabled = true;
        openModal('#modalTos');
      } else {
        accept.checked = true;
        btnSend.disabled = false;
      }
    });

    accept.addEventListener('change', ()=>{ btnSend.disabled = !accept.checked; });

    // reset do histórico local (apenas o aceite e respostas na UI)
    btnReset.addEventListener('click', ()=>{
      localStorage.removeItem(TOS_KEY);
      accept.checked = false;
      btnSend.disabled = true;
      feed.innerHTML = ''; feed.hidden = true;
      alert('Histórico local limpo. Reabra os Termos para continuar.');
    });

    // envio
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!accept.checked){ openModal('#modalTos'); return; }
      btnSend.disabled = true;

      const fd = new FormData(form);
      // renomeia input de arquivo para "photos" (múltiplos)
      const fileInput = document.getElementById('photos');
      if (fileInput?.files?.length){
        [...fileInput.files].forEach(f => fd.append('photos', f));
      }

      try{
        const rsp = await fetch('/chat', { method:'POST', body: fd });
        const data = await rsp.json();
        feed.hidden = false;

        const you = document.createElement('div');
        you.className = 'bubble you';
        you.textContent = document.getElementById('problem').value || '(sem texto)';
        feed.appendChild(you);

        const bot = document.createElement('div');
        bot.className = 'bubble bot';
        bot.textContent = data?.reply || data?.answer || data?.error || 'Sem resposta.';
        feed.appendChild(bot);

        feed.scrollTop = feed.scrollHeight;
      }catch(err){
        alert('Erro ao enviar. Tente novamente.');
      }finally{
        btnSend.disabled = !accept.checked;
      }
    });
  </script>
</body>
</html>
